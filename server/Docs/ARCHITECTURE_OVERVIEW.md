# üß≠ Nexy Server ‚Äî –û–±–∑–æ—Ä –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—ã

–≠—Ç–æ—Ç –¥–æ–∫—É–º–µ–Ω—Ç –æ–ø–∏—Å—ã–≤–∞–µ—Ç –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—É, —Å—Ç—Ä—É–∫—Ç—É—Ä—É –∏ –ª–æ–≥–∏–∫—É —Å–µ—Ä–≤–µ—Ä–Ω–æ–π —á–∞—Å—Ç–∏ Nexy: —Ä–æ–ª–∏ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤, –ø–æ—Ç–æ–∫ –¥–∞–Ω–Ω—ã—Ö, –∫–æ–Ω—Ç—Ä–∞–∫—Ç—ã gRPC, —Ä–∞–±–æ—Ç—É —Å –ø–∞–º—è—Ç—å—é/–ë–î, –ø—Ä–µ—Ä—ã–≤–∞–Ω–∏—è –∏ –∫–æ–Ω—Ç—Ä–æ–ª—å –∫–∞—á–µ—Å—Ç–≤–∞.

‚Äî –ê—É–¥–∏—Ç –∫–æ–¥–∞: server/main.py, grpc_server.py, text_processor.py, audio_generator.py, database/*, streaming.proto, update_server.py

---

## 1) –ö–∞—Ä—Ç–∏–Ω–∞ –≤ —Ü–µ–ª–æ–º

–°–µ—Ä–≤–µ—Ä ‚Äî –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã–π gRPC —Å–µ—Ä–≤–∏—Å –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ –∑–∞–ø—Ä–æ—Å–æ–≤ –æ—Ç –∫–ª–∏–µ–Ω—Ç–∞:
- –ü—Ä–∏–Ω–∏–º–∞–µ—Ç –ø—Ä–æ–º–ø—Ç –∏ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ) —Å–∫—Ä–∏–Ω—à–æ—Ç/–º–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ —ç–∫—Ä–∞–Ω–∞
- –ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç –æ—Ç–≤–µ—Ç–Ω—ã–µ —Ç–µ–∫—Å—Ç–æ–≤—ã–µ —á–∞–Ω–∫–∏ –∏ —Å–∏–Ω—Ç–µ–∑–∏—Ä—É–µ—Ç –∞—É–¥–∏–æ (TTS)
- –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –ø—Ä–µ—Ä—ã–≤–∞–Ω–∏–µ —Å–µ—Å—Å–∏–π (interrupt)
- –≠–∫—Å–ø–æ—Ä—Ç–∏—Ä—É–µ—Ç –ø—Ä–æ—Å—Ç—ã–µ HTTP endpoints –¥–ª—è health/status
- –û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ –ø–æ–¥–Ω–∏–º–∞–µ—Ç –≤—Å—Ç—Ä–æ–µ–Ω–Ω—ã–π Update Server (Sparkle/AppCast)

–ì–ª–∞–≤–Ω—ã–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã:
- grpc_server.py ‚Äî —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è gRPC —Å–µ—Ä–≤–∏—Å–∞ (StreamingServicer) –∏ ¬´serve¬ª
- text_processor.py ‚Äî –≥–µ–Ω–µ—Ä–∞—Ü–∏—è —Ç–µ–∫—Å—Ç–∞: Gemini Live API (–æ—Å–Ω–æ–≤–Ω–æ–π) / LangChain (fallback) / —É–ø—Ä–æ—â—ë–Ω–Ω—ã–π –æ—Ç–≤–µ—Ç
- audio_generator.py ‚Äî —Å–∏–Ω—Ç–µ–∑ —Ä–µ—á–∏: Azure Cognitive Services (–æ—Å–Ω–æ–≤–Ω–æ–π) / Edge TTS (fallback) / –ª–æ–∫–∞–ª—å–Ω—ã–π —Å–∏–Ω—É—Å
- database/* ‚Äî –º–µ–Ω–µ–¥–∂–µ—Ä –ë–î, —Ö—Ä–∞–Ω–µ–Ω–∏–µ —Å–µ—Å—Å–∏–π –∏ —Å–∫—Ä–∏–Ω—à–æ—Ç–æ–≤
- streaming.proto ‚Äî –∫–æ–Ω—Ç—Ä–∞–∫—Ç gRPC
- main.py ‚Äî —Ç–æ—á–∫–∞ –∑–∞–ø—É—Å–∫–∞ HTTP + gRPC (+ Update Server)

---

## 2) –ö–æ–Ω—Ç—Ä–∞–∫—Ç gRPC (streaming.proto)

–°–µ—Ä–≤–∏—Å: `StreamingService`
- `rpc StreamAudio(StreamRequest) returns (stream StreamResponse);` ‚Äî —Å–µ—Ä–≤–µ—Ä–Ω—ã–π —Å—Ç—Ä–∏–º–∏–Ω–≥
- `rpc InterruptSession(InterruptRequest) returns (InterruptResponse);` ‚Äî –ø—Ä–µ—Ä—ã–≤–∞–Ω–∏–µ –∞–∫—Ç–∏–≤–Ω—ã—Ö —Å–µ—Å—Å–∏–π

–°–æ–æ–±—â–µ–Ω–∏—è:
- `StreamRequest { string prompt; optional string screenshot; optional int32 screen_width; optional int32 screen_height; string hardware_id; optional string session_id; }`
- `StreamResponse { oneof content { string text_chunk; AudioChunk audio_chunk; string end_message; string error_message; } }`
- `AudioChunk { bytes audio_data; string dtype; repeated int32 shape; }`  ‚Äî dtype: –Ω–∞–ø—Ä–∏–º–µ—Ä `int16`; shape: `[N]`

–¢—Ä–µ–±–æ–≤–∞–Ω–∏—è —Å–æ–≥–ª–∞—Å–æ–≤–∞–Ω–∏—è —Å –∫–ª–∏–µ–Ω—Ç–æ–º:
- –ê—É–¥–∏–æ —Ñ–æ—Ä–º–∞—Ç: 48 kHz, mono, int16 (PCM s16le). –ï—Å–ª–∏ –¥–≤–∏–∂–æ–∫ TTS –≤—ã–¥–∞—ë—Ç –¥—Ä—É–≥–æ–π —Ñ–æ—Ä–º–∞—Ç, –∫–æ–Ω–≤–µ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ.
- –û—à–∏–±–∫–∏/–æ—Ç–º–µ–Ω–∞: –ø—Ä–∏ –∫–ª–∏–µ–Ω—Ç—Å–∫–æ–º –æ—Ç–º–µ–Ω–µ —Å—Ç—Ä–∏–º–∞ (context cancelled) –Ω–µ –æ—Ç–ø—Ä–∞–≤–ª—è—Ç—å `end_message`; –¥–æ–ø—É—Å–∫–∞–µ—Ç—Å—è –ª–æ–≥–∏—Ä–æ–≤–∞—Ç—å –æ—Ç–º–µ–Ω—É –∏ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ –∑–∞–≤–µ—Ä—à–∞—Ç—å –æ–±—Ä–∞–±–æ—Ç–∫—É –±–µ–∑ –æ—à–∏–±–æ–∫.

–†–∞–∑–º–µ—Ä—ã —Å–æ–æ–±—â–µ–Ω–∏–π: —Å–µ—Ä–≤–µ—Ä —Å–∫–æ–Ω—Ñ–∏–≥—É—Ä–∏—Ä–æ–≤–∞–Ω –Ω–∞ –ø—Ä–∏–µ–º/–æ—Ç–¥–∞—á—É –¥–æ 50MB.

---

## 3) –ü–æ—Ç–æ–∫ –æ–±—Ä–∞–±–æ—Ç–∫–∏ (StreamAudio)

1) –ü—Ä–∏—ë–º –∑–∞–ø—Ä–æ—Å–∞: prompt, hardware_id, screenshot (+—Ä–∞–∑–º–µ—Ä—ã —ç–∫—Ä–∞–Ω–∞)
2) –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Å–µ—Å—Å–∏–∏: —É—á—ë—Ç –≤ `active_sessions`, –≥–µ–Ω–µ—Ä–∞—Ü–∏—è `session_id` –ø—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏
3) –ì–µ–Ω–µ—Ä–∞—Ü–∏—è —Ç–µ–∫—Å—Ç–∞ (TextProcessor): –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã–π –≥–µ–Ω–µ—Ä–∞—Ç–æ—Ä —Ç–µ–∫—Å—Ç–æ–≤—ã—Ö —á–∞–Ω–∫–æ–≤
4) –î–ª—è –∫–∞–∂–¥–æ–≥–æ `text_chunk` ‚Äî —Å–∏–Ω—Ç–µ–∑ –∞—É–¥–∏–æ (AudioGenerator) ‚Üí –æ—Ç–ø—Ä–∞–≤–∫–∞ `StreamResponse.audio_chunk`
5) –§–∏–Ω–∞–ª–∏–∑–∞—Ü–∏—è: –æ—Ç–ø—Ä–∞–≤–∫–∞ `end_message` –∏ –∑–∞–∫—Ä—ã—Ç–∏–µ —Å—Ç—Ä–∏–º–∞; —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —Å–∫—Ä–∏–Ω—à–æ—Ç–∞ –≤ –ë–î (–µ—Å–ª–∏ —É–∫–∞–∑–∞–Ω)

–ü—Ä–µ—Ä—ã–≤–∞–Ω–∏—è –∏ –æ—Ç–º–µ–Ω–∞:
- –ö–ª–∏–µ–Ω—Ç –º–æ–∂–µ—Ç –æ—Ç–º–µ–Ω–∏—Ç—å –∞–∫—Ç–∏–≤–Ω—ã–π —Å—Ç—Ä–∏–º –¥–≤—É–º—è –ø—É—Ç—è–º–∏:
  1) –û—Ç–º–µ–Ω–∞ –∫–ª–∏–µ–Ω—Ç—Å–∫–æ–≥–æ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞ RPC (preferred –¥–ª—è ¬´barge‚Äëin¬ª). –°–µ—Ä–≤–µ—Ä –æ–±—è–∑–∞–Ω —á–∞—Å—Ç–æ –ø—Ä–æ–≤–µ—Ä—è—Ç—å `context.cancelled()`/`context.is_active()` –∏ –Ω–µ–º–µ–¥–ª–µ–Ω–Ω–æ –ø—Ä–µ–∫—Ä–∞—â–∞—Ç—å –≥–µ–Ω–µ—Ä–∞—Ü–∏—é —Ç–µ–∫—Å—Ç–∞/–∞—É–¥–∏–æ –±–µ–∑ –æ—Ç–ø—Ä–∞–≤–∫–∏ `end_message`.
  2) –í—ã–∑–æ–≤ `InterruptSession(hardware_id)` ‚Äî —Å–µ—Ä–≤–µ—Ä –≤—ã—Å—Ç–∞–≤–ª—è–µ—Ç `global_interrupt_flag` –∏ –ø–æ–º–µ—á–∞–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã–µ —Å–µ—Å—Å–∏–∏ –∫–∞–∫ `cancelled`, —á—Ç–æ –ø—Ä–µ—Ä—ã–≤–∞–µ—Ç –≥–µ–Ω–µ—Ä–∞—Ü–∏—é.
- –ì–µ–Ω–µ—Ä–∞—Ç–æ—Ä—ã (—Ç–µ–∫—Å—Ç/–∞—É–¥–∏–æ) –¥–æ–ª–∂–Ω—ã —Ä–µ–≥—É–ª—è—Ä–Ω–æ –ø—Ä–æ–≤–µ—Ä—è—Ç—å –æ–±–∞ —Å–∏–≥–Ω–∞–ª–∞: –≥–ª–æ–±—Ñ–ª–∞–≥/—Å—Ç–∞—Ç—É—Å —Å–µ—Å—Å–∏–∏ –∏ –æ—Ç–º–µ–Ω—É –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞.
- –ü–æ—Å–ª–µ –æ—Ç–º–µ–Ω—ã –Ω–∏–∫–∞–∫–∏—Ö ¬´–ø–æ–∑–¥–Ω–∏—Ö¬ª —á–∞–Ω–∫–æ–≤ –Ω–µ –¥–æ–ª–∂–Ω—ã –æ—Ç–ø—Ä–∞–≤–ª—è—Ç—å—Å—è –≤ –ø–æ—Ç–æ–∫ (–≤–∞–∂–Ω–æ –¥–ª—è –∫–ª–∏–µ–Ω—Ç—Å–∫–æ–≥–æ —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏ –∏ UX barge‚Äëin).

–•—Ä–∞–Ω–µ–Ω–∏–µ:
- –ü—Ä–∏ –Ω–∞–ª–∏—á–∏–∏ —Å–∫—Ä–∏–Ω—à–æ—Ç–∞ ‚Äî —Å–æ–∑–¥–∞–µ—Ç—Å—è –∑–∞–ø–∏—Å—å –≤ –ë–î (`database_manager.create_screenshot`) —Å –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–º–∏.

---

## 4) –ì–µ–Ω–µ—Ä–∞—Ü–∏—è —Ç–µ–∫—Å—Ç–∞ (text_processor.py)

–°—Ç—Ä–∞—Ç–µ–≥–∏—è ¬´–º–Ω–æ–≥–æ—É—Ä–æ–≤–Ω–µ–≤—ã–π —Ñ–æ–ª–±—ç–∫¬ª:
- –û—Å–Ω–æ–≤–Ω–æ–π: Google Gemini Live API (–µ—Å–ª–∏ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –∏ –Ω–∞—Å—Ç—Ä–æ–µ–Ω)
  - –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ø–æ–∏—Å–∫–æ–≤–æ–≥–æ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∞ (–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ –¥–ª—è ¬´–∞–∫—Ç—É–∞–ª—å–Ω–æ–π¬ª –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏)
  - System prompt (role/–ø—Ä–∞–≤–∏–ª–∞ –æ—Ç–≤–µ—Ç–∞) –∑–∞–¥–∞–µ—Ç—Å—è –≤ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ —Å–µ—Å—Å–∏–∏
- Fallback: LangChain + Gemini (–µ—Å–ª–∏ –¥–æ—Å—Ç—É–ø–Ω–æ)
- –õ–æ–∫–∞–ª—å–Ω—ã–π —É–ø—Ä–æ—â—ë–Ω–Ω—ã–π —Ñ–æ–ª–±—ç–∫: –µ—Å–ª–∏ –Ω–µ—Ç –∫–ª—é—á–µ–π/SDK ‚Äî –æ—Ç–¥–∞—ë—Ç—Å—è –∫–æ—Ä–æ—Ç–∫–∏–π —Ç–µ–∫—Å—Ç–æ–≤—ã–π –æ—Ç–≤–µ—Ç-–∑–∞–≥–ª—É—à–∫–∞

–û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏:
- –ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã–π –≥–µ–Ω–µ—Ä–∞—Ç–æ—Ä —Ç–µ–∫—Å—Ç–∞ (streaming), –æ—Ç–¥–∞—ë—Ç ¬´–∫—É—Å–æ—á–∫–∏¬ª —Ç–µ–∫—Å—Ç–∞
- –ò–º–µ–µ—Ç—Å—è –º–≥–Ω–æ–≤–µ–Ω–Ω–∞—è –æ—Ç–º–µ–Ω–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ (`cancel_generation()`)
- –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å –ø–∞–º—è—Ç—å—é/–ë–î (MemoryAnalyzer) ‚Äî –æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ –ø—Ä–∏ –Ω–∞–ª–∏—á–∏–∏ –∫–ª—é—á–µ–π

---

## 5) –°–∏–Ω—Ç–µ–∑ –∞—É–¥–∏–æ (audio_generator.py)

–°—Ç—Ä–∞—Ç–µ–≥–∏—è ¬´–º–Ω–æ–≥–æ—É—Ä–æ–≤–Ω–µ–≤—ã–π —Ñ–æ–ª–±—ç–∫¬ª:
- –û—Å–Ω–æ–≤–Ω–æ–π: Azure Cognitive Services TTS
  - –í—ã—Ö–æ–¥: 48000Hz, 16-bit, mono PCM
  - –ö–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏—è –≤ numpy –º–∞—Å—Å–∏–≤ `int16`
- Fallback: Edge TTS (WebSocket) —Å retry –∏ timeout
- –õ–æ–∫–∞–ª—å–Ω—ã–π —Ñ–æ–ª–±—ç–∫: —Å–∏–Ω—É—Å/¬´–±–∏–ø¬ª –¥–ª—è –∫—Ä–∞–π–Ω–µ–≥–æ —Å–ª—É—á–∞—è

–ù–∞ –≤—ã—Ö–æ–¥ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è `AudioChunk` —Å `audio_data` (raw bytes), `dtype` (–Ω–∞–ø—Ä–∏–º–µ—Ä `int16`) –∏ `shape` (`[N]`).

---

## 6) –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö –∏ –ø–∞–º—è—Ç—å

- `database/database_manager.py` ‚Äî –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –ë–î (SQLite –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é), CRUD —Å–µ—Å—Å–∏–π –∏ —Å–∫—Ä–∏–Ω—à–æ—Ç–æ–≤
- –°–æ–∑–¥–∞–Ω–∏–µ —Å–∫—Ä–∏–Ω—à–æ—Ç–∞: –ø—É—Ç—å (–ª–æ–∫–∞–ª—å–Ω—ã–π), URL (–æ–ø—Ü.), –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ (base64_length, —Ñ–æ—Ä–º–∞—Ç, —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–µ —ç–∫—Ä–∞–Ω–∞)
- `TextProcessor.set_database_manager(...)` ‚Äî –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è –¥–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –ø–∞–º—è—Ç–∏/–∏—Å—Ç–æ—Ä–∏–∏ –ø—Ä–∏ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏

---

## 7) –ü—Ä–µ—Ä—ã–≤–∞–Ω–∏—è (InterruptSession)

- RPC: `InterruptSession(InterruptRequest{hardware_id})` ‚Üí `InterruptResponse{success, interrupted_sessions, message}`
- –ú–µ—Ö–∞–Ω–∏–∫–∞:
  - –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç—Å—è `global_interrupt_flag` –∏ `interrupt_hardware_id`
  - –í—Å–µ –∞–∫—Ç–∏–≤–Ω—ã–µ —Å–µ—Å—Å–∏–∏ –ø–æ–º–µ—á–∞—é—Ç—Å—è `cancelled=True`
  - –í —Ü–∏–∫–ª–µ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ —Ç–µ–∫—Å—Ç–∞/–∞—É–¥–∏–æ –µ—Å—Ç—å —á–∞—Å—Ç—ã–µ –ø—Ä–æ–≤–µ—Ä–∫–∏ —Ñ–ª–∞–≥–∞ –∏ —Å—Ç–∞—Ç—É—Å–∞ —Å–µ—Å—Å–∏–∏
- –ö–ª–∏–µ–Ω—Ç –ø–æ—Å–ª–µ –ø—Ä–µ—Ä—ã–≤–∞–Ω–∏—è –æ–±—ã—á–Ω–æ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –≤ `SLEEPING`

---

## 8) –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è (config.py, config.env)

- –ü–∞—Ä–∞–º–µ—Ç—Ä—ã: –∫–ª—é—á–∏ Gemini/ Azure Speech, –ø–æ—Ä—Ç gRPC/HTTP, –ë–î, –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ Edge TTS
- `Config.validate()` –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è –ø—Ä–∏ –∑–∞–ø—É—Å–∫–µ –∏–∑ `grpc_server` (–≤ __main__) –∏ –≤ main.py –ø–æ –º–µ—Å—Ç—É
- –í –ø—Ä–æ–¥–µ –≤—Å–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –∑–∞–¥–∞—é—Ç—Å—è —á–µ—Ä–µ–∑ `config.env`/–ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è

---

## 9) –ó–∞–ø—É—Å–∫ –∏ —Å–µ—Ä–≤–∏—Å—ã (main.py)

- HTTP (aiohttp) –Ω–∞ 8080: `/health`, `/`, `/status`
- gRPC –Ω–∞ `Config.GRPC_PORT` (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é 50051)
- Update Server (–æ–ø—Ü.) –Ω–∞ 8081: AppCast –∏ —Ä–∞–∑–¥–∞—á–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π
- –í—Å–µ —Å–µ—Ä–≤–∏—Å—ã –∑–∞–ø—É—Å–∫–∞—é—Ç—Å—è –∏–∑ `async def main()`; –∫–æ—Ä—Ä–µ–∫—Ç–Ω–∞—è –æ—Å—Ç–∞–Ω–æ–≤–∫–∞ –ø–æ Ctrl+C

---

## 10) –ú–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏–µ –∏ –Ω–∞–¥–µ–∂–Ω–æ—Å—Ç—å

- –ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã–π gRPC (`grpc.aio`) —Å –Ω–∞—Å—Ç—Ä–æ–π–∫–∞–º–∏ –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–≥–æ —Ä–∞–∑–º–µ—Ä–∞ —Å–æ–æ–±—â–µ–Ω–∏–π (50MB)
- –ü–∞—Ä–∞–ª–ª–µ–ª—å–Ω—ã–µ —Å–µ—Å—Å–∏–∏: —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —á–µ—Ä–µ–∑ `active_sessions` + –ø—Ä–æ–≤–µ—Ä–∫–∏ –æ—Ç–º–µ–Ω—ã
- –ü–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω—ã–π –≥–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω—ã–π —Å–∫–µ–π–ª: –∑–∞ —Å—á—ë—Ç stateless‚Äë–ª–æ–≥–∏–∫–∏; –≥–ª–æ–±—Ñ–ª–∞–≥ –ø—Ä–µ—Ä—ã–≤–∞–Ω–∏—è –∏ –∞–∫—Ç–∏–≤–Ω—ã–µ —Å–µ—Å—Å–∏–∏ –ø—Ä–∏–≤—è–∑–∞–Ω—ã –∫ –∏–Ω—Å—Ç–∞–Ω—Å—É (–¥–ª—è –º—É–ª—å—Ç–∏‚Äë–∏–Ω—Å—Ç–∞–Ω—Å–∞ —Ç—Ä–µ–±—É–µ—Ç—Å—è –≤–Ω–µ—à–Ω–∏–π –∫–æ–æ—Ä–¥–∏–Ω–∞—Ü–∏–æ–Ω–Ω—ã–π —Å–ª–æ–π: Redis/pubsub)
- –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ø—Ä–æ–¥–∞–∫—à–Ω:
  - –ü—Ä–æ–ø–∞–≥–∏—Ä–æ–≤–∞—Ç—å interrupt —á–µ—Ä–µ–∑ –≤–Ω–µ—à–Ω–∏–π —Å—Ç–æ—Ä (Redis) –ø—Ä–∏ k>1 –∏–Ω—Å—Ç–∞–Ω—Å–µ
  - –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —Å–∫—Ä–∏–Ω—à–æ—Ç–æ–≤/–ª–æ–≥–æ–≤ –≤ object storage (S3/GCS) –≤–º–µ—Å—Ç–æ –ª–æ–∫–∞–ª—å–Ω–æ–≥–æ `/tmp`
  - –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ –≤—Ä–µ–º–µ–Ω–∏ —Å–µ—Å—Å–∏–∏/—Ç–∞–π–º‚Äë–∞—É—Ç—ã –Ω–∞ —É—Ä–æ–≤–Ω–µ gRPC –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞

---

## 11) –ù–∞–±–ª—é–¥–∞–µ–º–æ—Å—Ç—å –∏ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ

- –ï–¥–∏–Ω–∞—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∞ logging.basicConfig –≤ grpc_server/main
- –ü–æ–¥—Ä–æ–±–Ω—ã–µ –ª–æ–≥–∏ –Ω–∞ –∫–ª—é—á–µ–≤—ã—Ö —ç—Ç–∞–ø–∞—Ö: –ø—Ä–∏—ë–º –∑–∞–ø—Ä–æ—Å–∞, –Ω–∞—á–∞–ª–æ/–æ–∫–æ–Ω—á–∞–Ω–∏–µ —Å—Ç—Ä–∏–º–∞, –≥–µ–Ω–µ—Ä–∞—Ü–∏—è/TT–°, –ø—Ä–µ—Ä—ã–≤–∞–Ω–∏—è (–≤–∫–ª—é—á–∞—è –æ—Ç–ª–∏—á–µ–Ω–∏–µ client‚Äëcancel vs server‚Äëerror)
- –î–∏–∞–≥–Ω–æ—Å—Ç–∏—á–µ—Å–∫–∏–µ –ø—Ä–∏–Ω—Ç—ã –≤–∫–ª—é—á–µ–Ω—ã –≤ StreamAudio –¥–ª—è –ª–æ–∫–∞–ª—å–Ω–æ–π –æ—Ç–ª–∞–¥–∫–∏ (–º–æ–∂–Ω–æ –æ—Ç–∫–ª—é—á–∏—Ç—å/–ø–æ–Ω–∏–∑–∏—Ç—å —É—Ä–æ–≤–µ–Ω—å)

---

## 12) –ß–µ–∫‚Äë–ª–∏—Å—Ç –∏–Ω–≤–∞—Ä–∏–∞–Ω—Ç–æ–≤

- [ ] –õ—é–±–∞—è –≥–µ–Ω–µ—Ä–∞—Ü–∏—è —Ç–µ–∫—Å—Ç–∞ –æ—Ç–º–µ–Ω—è–µ–º–∞ (cancel_generation + –ø—Ä–æ–≤–µ—Ä–∫–∏ —Ñ–ª–∞–≥–æ–≤)
- [ ] TTS –≤—Å–µ–≥–¥–∞ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç: 48 kHz, int16 mono (–∏–ª–∏ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ –∫–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ—Ç—Å—è)
- [ ] –ö–æ–Ω—Ç–µ–∫—Å—Ç gRPC –ø—Ä–æ–≤–µ—Ä—è–µ—Ç—Å—è –Ω–∞ –æ—Ç–º–µ–Ω—É –≤–Ω—É—Ç—Ä–∏ —Ü–∏–∫–ª–æ–≤
- [ ] –†–∞–∑–º–µ—Ä—ã —Å–æ–æ–±—â–µ–Ω–∏–π —Å–æ–≥–ª–∞—Å–æ–≤–∞–Ω—ã —Å –∫–ª–∏–µ–Ω—Ç–æ–º (–¥–æ 50MB)
- [ ] –ü—Ä–∏ –Ω–∞–ª–∏—á–∏–∏ —Å–∫—Ä–∏–Ω—à–æ—Ç–∞ —Å–æ–∑–¥–∞—ë—Ç—Å—è –∑–∞–ø–∏—Å—å –≤ –ë–î —Å –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–º–∏

‚Äî –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ –¥–ª—è barge‚Äëin –∫–ª–∏–µ–Ω—Ç–∞ (press‚Äëfirst):
- [ ] –ü—Ä–∏ –æ—Ç–º–µ–Ω–µ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞ —Å—Ç—Ä–∏–º –º–≥–Ω–æ–≤–µ–Ω–Ω–æ –ø—Ä–µ–∫—Ä–∞—â–∞–µ—Ç—Å—è, –±–µ–∑ ¬´—Ö–≤–æ—Å—Ç–æ–≤—ã—Ö¬ª –∞—É–¥–∏–æ —á–∞–Ω–∫–æ–≤
- [ ] –ù–µ—Ç –æ—Ç–ø—Ä–∞–≤–∫–∏ `end_message` –ø—Ä–∏ –æ—Ç–º–µ–Ω–µ; –¥–æ–ø—É—Å–∫–∞–µ—Ç—Å—è –ª–æ–≥ ¬´cancelled by client¬ª

---

## 13) –ü–æ–ª–µ–∑–Ω—ã–µ —Ñ–∞–π–ª—ã

- gRPC —Å–µ—Ä–≤–∏—Å: `server/grpc_server.py`, `server/streaming.proto`
- –¢–µ–∫—Å—Ç: `server/text_processor.py`
- –ê—É–¥–∏–æ: `server/audio_generator.py`
- –ë–î: `server/database/database_manager.py`
- –ö–æ–Ω—Ñ–∏–≥: `server/config.py`, `server/config.env(.example)`
- –ó–∞–ø—É—Å–∫: `server/main.py`
- –û–±–Ω–æ–≤–ª–µ–Ω–∏—è: `server/update_server.py`, `server/updates/*`

–ï—Å–ª–∏ —á–µ–≥–æ‚Äë—Ç–æ –Ω–µ —Ö–≤–∞—Ç–∞–µ—Ç ‚Äî —Å–æ–∑–¥–∞–π—Ç–µ Issue/PR, —ç—Ç–æ—Ç –¥–æ–∫—É–º–µ–Ω—Ç —è–≤–ª—è–µ—Ç—Å—è ¬´–∏—Å—Ç–æ—á–Ω–∏–∫–æ–º –∏—Å—Ç–∏–Ω—ã¬ª –ø–æ —Å–µ—Ä–≤–µ—Ä–Ω–æ–π –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–µ.

---

## 14) –î–∏–∞–≥—Ä–∞–º–º—ã (Mermaid)

–ü–æ—Ç–æ–∫ StreamAudio (—Å–µ—Ä–≤–µ—Ä–Ω—ã–π —Å—Ç—Ä–∏–º–∏–Ω–≥)

```mermaid
sequenceDiagram
    participant Client
    participant GRPC as StreamingService (gRPC)
    participant TP as TextProcessor
    participant TTS as AudioGenerator
    participant DB as Database

    Client->>GRPC: StreamAudio(StreamRequest)
    GRPC->>TP: generate text (async)
    loop text chunks
        TP-->>GRPC: text_chunk
        GRPC->>TTS: synthesize(text_chunk)
        TTS-->>GRPC: AudioChunk(bytes,int16,[N])
        GRPC-->>Client: StreamResponse.audio_chunk
    end
    alt has screenshot
        GRPC->>DB: create_screenshot(session_id, meta)
    end
    GRPC-->>Client: StreamResponse.end_message
```

–ü—Ä–µ—Ä—ã–≤–∞–Ω–∏–µ —Å–µ—Å—Å–∏–π (–¥–≤–∞ –ø—É—Ç–∏)

```mermaid
sequenceDiagram
    participant Client
    participant GRPC as StreamingService
    participant TP as TextProcessor

    rect rgb(240,250,240)
    note over Client,GRPC: –ü—É—Ç—å 1 (–ø—Ä–µ–¥–ø–æ—á—Ç–∏—Ç–µ–ª—å–Ω—ã–π –¥–ª—è barge‚Äëin)
    Client-xGRPC: cancel client stream (context cancelled)
    GRPC->>TP: cancel_generation()
    note right of GRPC: –ì–µ–Ω–µ—Ä–∞—Ç–æ—Ä—ã –ø—Ä–æ–≤–µ—Ä—è—é—Ç context.cancelled()
    end

    rect rgb(250,240,240)
    note over Client,GRPC: –ü—É—Ç—å 2 (RPC –æ—Ç–º–µ–Ω—ã)
    Client->>GRPC: InterruptSession(hardware_id)
    GRPC->>GRPC: set global_interrupt_flag + mark sessions cancelled
    GRPC->>TP: cancel_generation()
    GRPC-->>Client: InterruptResponse{success, interrupted_sessions}
    end
```

–û–±—â–∏–π –≤–∏–¥ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤ —Å–µ—Ä–≤–µ—Ä–∞

```mermaid
flowchart LR
  subgraph Runtime
    A[HTTP Server :8080\n/health /status]
    B[gRPC Server :50051\nStreamingService]
    C[Update Server :8081\nAppCast/Downloads]
  end
  B --> TP[TextProcessor\nGemini Live / LangChain / Fallback]
  B --> TTS[AudioGenerator\nAzure / Edge TTS / Local]
  B --> DB[(Database)]
  Client[[Client App]] -->|gRPC| B
  Client -.->|HTTP (health)| A
```
