# План устранения архитектурных дублирований

## Цель
Привести сервер Nexy к архитектуре с единственными точками инициализации, единым управлением прерываниями и чистыми интеграциями без дублирующей логики.

## Итерация 1 — Управление жизненным циклом модулей
1. Обновить `ModuleCoordinatorIntegration`, чтобы:
   - перед вызовом `initialize()` проверять `module.is_initialized`;
   - пропускать `start/stop`, если методы отсутствуют, ограничиваясь логом уровня `DEBUG`.
2. Проверить, что после запуска нет повторного подключения к внешним сервисам (Gemini, Azure, PostgreSQL).

## Итерация 2 — Единый Interrupt Manager
1. Передать экземпляр `InterruptManager`, создаваемый `GrpcServiceManager`, в gRPC сервер.
2. Убрать создание второго `InterruptManager` в `grpc_server.py`.
3. Убедиться, что глобальные флаги/сессии видны и workflow, и gRPC слою.

## Итерация 3 — Делегирование текстовой фильтрации
1. Перенести fallback-очистку, разбиение и подсчёт слов из `StreamingWorkflowIntegration` в `TextFilterManager`.
2. В интеграции оставить только делегирование к модулю + минимальный аварийный fallback.

## Итерация 4 — Наведение порядка в импортируемых путях
1. Удалить `sys.path.append` из серверных модулей.
2. Настроить относительные импорты и обеспечить запуск через `python -m server.main`.

## Итерация 5 — Удаление устаревших gRPC интеграций
1. Переместить `server/integrations/grpc_integrations` в `legacy/` (или удалить, если не используется).
2. Обновить импорты, чтобы все сервисы работали только через `service_integrations`/`workflow_integrations`.

## Итерация 6 — Память и база данных
1. При создании `MemoryWorkflowIntegration` передавать экземпляр `DatabaseManager`.
2. Реализовать запись результатов анализа памяти в базу и убрать предупреждение `DatabaseManager is not set`.

## Итоговая проверка
- Прогнать end-to-end сценарий (gRPC запрос + аудио) и убедиться в отсутствии повторных инициализаций.
- Проверить логи на отсутствие предупреждений о дублирующих модулях и несинхронизированных прерываниях.
