name: Deploy to Azure VM

on:
  push:
    branches: [ main ]
    paths: [ 'main.py', 'modules/**', 'integrations/**', 'config/**', 'requirements.txt' ]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: Deploy to Azure VM
      uses: azure/CLI@v1
      with:
        inlineScript: |
          echo "üöÄ –ù–∞—á–∏–Ω–∞–µ–º –¥–µ–ø–ª–æ–π –Ω–∞ Azure VM..."
          
          # –í—ã–ø–æ–ª–Ω—è–µ–º –∫–æ–º–∞–Ω–¥—É –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –Ω–∞ VM
          az vm run-command invoke \
            --resource-group Nexy \
            --name nexy-regular \
            --command-id RunShellScript \
            --scripts @/home/azureuser/update-server.sh
          
          echo "‚úÖ –î–µ–ø–ª–æ–π –∑–∞–≤–µ—Ä—à–µ–Ω"
          
          # –ü—Ä–æ–≤–µ—Ä—è–µ–º health endpoint
          echo "üîç –ü—Ä–æ–≤–µ—Ä—è–µ–º health endpoint..."
          sleep 10
          
          # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç–∞—Ç—É—Å —Å–µ—Ä–≤–∏—Å–∞
          az vm run-command invoke \
            --resource-group Nexy \
            --name nexy-regular \
            --command-id RunShellScript \
            --scripts "systemctl is-active voice-assistant.service"
          
          echo "üéâ –î–µ–ø–ª–æ–π —É—Å–ø–µ—à–Ω–æ –∑–∞–≤–µ—Ä—à–µ–Ω!"
      env:
        AZURE_CLIENT_ID: ${{ secrets.AZURE_CLIENT_ID }}
        AZURE_CLIENT_SECRET: ${{ secrets.AZURE_CLIENT_SECRET }}
        AZURE_TENANT_ID: ${{ secrets.AZURE_TENANT_ID }}
        AZURE_SUBSCRIPTION_ID: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
