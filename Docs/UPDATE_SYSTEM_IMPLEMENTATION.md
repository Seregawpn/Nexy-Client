# üîÑ –í–Ω–µ–¥—Ä–µ–Ω–∏–µ –Ω–æ–≤–æ–π —Å–∏—Å—Ç–µ–º—ã –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π "–±–µ–∑ –ø–∞—Ä–æ–ª—è"

**–î–∞—Ç–∞:** 19 —Å–µ–Ω—Ç—è–±—Ä—è 2025  
**–°—Ç–∞—Ç—É—Å:** –ì–æ—Ç–æ–≤ –∫ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏  
**–í—Ä–µ–º—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏:** 4-5 —á–∞—Å–æ–≤  

## üéØ –¶–µ–ª—å

–ó–∞–º–µ–Ω–∏—Ç—å –Ω–µ—Ä–∞–±–æ—Ç–∞—é—â—É—é —Å–∏—Å—Ç–µ–º—É –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π Sparkle –Ω–∞ –ø—Ä–æ—Å—Ç—É—é –∏ –Ω–∞–¥–µ–∂–Ω—É—é HTTP-—Å–∏—Å—Ç–µ–º—É —Å –º–∏–≥—Ä–∞—Ü–∏–µ–π –≤ `~/Applications`, –æ–±–µ—Å–ø–µ—á–∏–≤–∞—é—â—É—é –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –±–µ–∑ –∑–∞–ø—Ä–æ—Å–∞ –ø–∞—Ä–æ–ª—è –ø–æ—Å–ª–µ –ø–µ—Ä–≤–æ–π —É—Å—Ç–∞–Ω–æ–≤–∫–∏.

---

## üìã –û–±–∑–æ—Ä –∏–∑–º–µ–Ω–µ–Ω–∏–π

### **–¢–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ (–ø—Ä–æ–±–ª–µ–º—ã)**
- ‚ùå `update_manager.enabled: false` - —Å–∏—Å—Ç–µ–º–∞ –æ—Ç–∫–ª—é—á–µ–Ω–∞
- ‚ùå SparkleHandler —Å–æ–¥–µ—Ä–∂–∏—Ç —Ç–æ–ª—å–∫–æ –∑–∞–≥–ª—É—à–∫–∏
- ‚ùå –ù–µ—Ç PKG —Ñ–∞–π–ª–æ–≤ –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π
- ‚ùå –°–ª–æ–∂–Ω–∞—è –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å PyInstaller
- ‚ùå –¢—Ä–µ–±—É–µ—Ç –ø–∞—Ä–æ–ª—å –ø—Ä–∏ –∫–∞–∂–¥–æ–º –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏

### **–¶–µ–ª–µ–≤–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ**
- ‚úÖ –ü—Ä–æ—Å—Ç–∞—è HTTP-—Å–∏—Å—Ç–µ–º–∞ —Å JSON –º–∞–Ω–∏—Ñ–µ—Å—Ç–æ–º
- ‚úÖ –ú–∏–≥—Ä–∞—Ü–∏—è –≤ `~/Applications` (–ø–∞—Ä–æ–ª—å —Ç–æ–ª—å–∫–æ –æ–¥–∏–Ω —Ä–∞–∑)
- ‚úÖ –ê—Ç–æ–º–∞—Ä–Ω–∞—è –∑–∞–º–µ–Ω–∞ .app —Ñ–∞–π–ª–æ–≤
- ‚úÖ –ú–Ω–æ–≥–æ—É—Ä–æ–≤–Ω–µ–≤–∞—è –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å (sha256 + ed25519 + codesign)
- ‚úÖ –ü–æ–ª–Ω–∞—è –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å EventBus –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–æ–π

---

## üèóÔ∏è –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ –Ω–æ–≤–æ–π —Å–∏—Å—Ç–µ–º—ã

### **–ü—Ä–∏–Ω—Ü–∏–ø —Ä–∞–±–æ—Ç—ã**
1. **–ü–µ—Ä–≤—ã–π –∑–∞–ø—É—Å–∫**: PKG ‚Üí –º–∏–≥—Ä–∞—Ü–∏—è –≤ `~/Applications/Nexy.app`
2. **–ü–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–∏–µ –ø—Ä–æ–≤–µ—Ä–∫–∏**: HTTP –∑–∞–ø—Ä–æ—Å –∫ –º–∞–Ω–∏—Ñ–µ—Å—Ç—É
3. **–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ**: DMG ‚Üí –ø—Ä–æ–≤–µ—Ä–∫–∏ ‚Üí –∞—Ç–æ–º–∞—Ä–Ω–∞—è –∑–∞–º–µ–Ω–∞ ‚Üí –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫
4. **–ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å**: 3 —É—Ä–æ–≤–Ω—è –ø—Ä–æ–≤–µ—Ä–∫–∏ (hash, signature, codesign)

### **–°—Ç—Ä—É–∫—Ç—É—Ä–∞ —Ñ–∞–π–ª–æ–≤**
```
client/
‚îú‚îÄ‚îÄ modules/updater/                    # –ù–æ–≤—ã–π –º–æ–¥—É–ª—å –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π
‚îÇ   ‚îú‚îÄ‚îÄ __init__.py
‚îÇ   ‚îú‚îÄ‚îÄ config.py                      # –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è
‚îÇ   ‚îú‚îÄ‚îÄ net.py                         # HTTP –∫–ª–∏–µ–Ω—Ç
‚îÇ   ‚îú‚îÄ‚îÄ verify.py                      # –ü—Ä–æ–≤–µ—Ä–∫–∏ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏
‚îÇ   ‚îú‚îÄ‚îÄ dmg.py                         # –†–∞–±–æ—Ç–∞ —Å DMG
‚îÇ   ‚îú‚îÄ‚îÄ replace.py                     # –ê—Ç–æ–º–∞—Ä–Ω–∞—è –∑–∞–º–µ–Ω–∞
‚îÇ   ‚îú‚îÄ‚îÄ migrate.py                     # –ú–∏–≥—Ä–∞—Ü–∏—è –≤ ~/Applications
‚îÇ   ‚îú‚îÄ‚îÄ updater.py                     # –û—Å–Ω–æ–≤–Ω–∞—è –ª–æ–≥–∏–∫–∞
‚îÇ   ‚îî‚îÄ‚îÄ scheduler.py                   # –ü–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫
‚îú‚îÄ‚îÄ integration/integrations/
‚îÇ   ‚îî‚îÄ‚îÄ updater_integration.py         # –ó–∞–º–µ–Ω–∞ UpdateManagerIntegration
‚îî‚îÄ‚îÄ config/
    ‚îî‚îÄ‚îÄ unified_config.yaml            # –û–±–Ω–æ–≤–ª–µ–Ω–Ω–∞—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è

server/
‚îú‚îÄ‚îÄ update_server.py                   # –û–±–Ω–æ–≤–ª–µ–Ω–Ω—ã–π —Å–µ—Ä–≤–µ—Ä
‚îú‚îÄ‚îÄ updates/
‚îÇ   ‚îú‚îÄ‚îÄ manifests/
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ manifest.json              # JSON –º–∞–Ω–∏—Ñ–µ—Å—Ç
‚îÇ   ‚îú‚îÄ‚îÄ artifacts/
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ Nexy-2.6.0.dmg            # DMG —Ñ–∞–π–ª—ã
‚îÇ   ‚îî‚îÄ‚îÄ scripts/
‚îÇ       ‚îú‚îÄ‚îÄ make_dmg.sh                # –°–æ–∑–¥–∞–Ω–∏–µ DMG
‚îÇ       ‚îú‚îÄ‚îÄ sign_ed25519.py            # –ü–æ–¥–ø–∏—Å—å –∞—Ä—Ç–µ—Ñ–∞–∫—Ç–æ–≤
‚îÇ       ‚îî‚îÄ‚îÄ make_manifest.py           # –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –º–∞–Ω–∏—Ñ–µ—Å—Ç–∞
```

---

## üîß –≠—Ç–∞–ø 1: –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ (30 –º–∏–Ω—É—Ç)

### **1.1 –°–æ–∑–¥–∞–Ω–∏–µ —Å—Ç—Ä—É–∫—Ç—É—Ä—ã –º–æ–¥—É–ª–µ–π**
```bash
# –°–æ–∑–¥–∞–µ–º –Ω–æ–≤—É—é —Å—Ç—Ä—É–∫—Ç—É—Ä—É
mkdir -p client/modules/updater
mkdir -p server/updates/{artifacts,manifests,scripts}

# –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏
pip install urllib3 pynacl packaging
```

### **1.2 –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ requirements.txt**
```bash
echo "urllib3>=1.26.0" >> client/requirements.txt
echo "pynacl>=1.5.0" >> client/requirements.txt
echo "packaging>=21.0" >> client/requirements.txt
```

### **1.3 –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏**
```yaml
# client/config/unified_config.yaml - –¥–æ–±–∞–≤–∏—Ç—å —Å–µ–∫—Ü–∏—é
updater:
  enabled: true
  manifest_url: "https://updates.nexy.ai/manifest.json"
  check_interval: 3600
  auto_install: true
  security:
    public_key: "BASE64_PUBLIC_ED25519_KEY"
  timeout: 20
  retries: 3
  ui:
    show_notifications: true
    auto_download: true
```

---

## üöÄ –≠—Ç–∞–ø 2: –†–µ–∞–ª–∏–∑–∞—Ü–∏—è –º–æ–¥—É–ª–µ–π (3-4 —á–∞—Å–∞)

### **2.1 –ë–∞–∑–æ–≤—ã–µ –º–æ–¥—É–ª–∏**

#### **config.py** - –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π
```python
from dataclasses import dataclass
from typing import Optional

@dataclass
class UpdaterConfig:
    enabled: bool = True
    manifest_url: str = ""
    check_interval: int = 3600
    auto_install: bool = True
    public_key: str = ""
    timeout: int = 20
    retries: int = 3
    show_notifications: bool = True
    auto_download: bool = True
```

#### **net.py** - HTTP –∫–ª–∏–µ–Ω—Ç —Å —Ä–µ—Ç—Ä–∞—è–º–∏
```python
import urllib3
import os
import logging
from typing import Optional

logger = logging.getLogger(__name__)

class UpdateHTTPClient:
    def __init__(self, timeout: int = 20, retries: int = 3):
        self.http = urllib3.PoolManager(
            retries=urllib3.Retry(total=retries, backoff_factor=0.5),
            timeout=urllib3.Timeout(total=timeout)
        )
    
    def get_manifest(self, url: str) -> dict:
        """–ü–æ–ª—É—á–µ–Ω–∏–µ –º–∞–Ω–∏—Ñ–µ—Å—Ç–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π"""
        response = self.http.request("GET", url)
        if response.status != 200:
            raise RuntimeError(f"HTTP {response.status}")
        return response.json()
    
    def download_file(self, url: str, dest_path: str, expected_size: Optional[int] = None):
        """–°–∫–∞—á–∏–≤–∞–Ω–∏–µ —Ñ–∞–π–ª–∞ —Å –ø—Ä–æ–≤–µ—Ä–∫–æ–π —Ä–∞–∑–º–µ—Ä–∞"""
        with self.http.request("GET", url, preload_content=False) as response:
            if response.status != 200:
                raise RuntimeError(f"HTTP {response.status}")
            
            with open(dest_path, "wb") as f:
                for chunk in response.stream(1024 * 1024):
                    f.write(chunk)
        
        if expected_size and os.path.getsize(dest_path) != expected_size:
            raise RuntimeError("–†–∞–∑–º–µ—Ä —Ñ–∞–π–ª–∞ –Ω–µ —Å–æ–≤–ø–∞–¥–∞–µ—Ç")
```

#### **verify.py** - –ü—Ä–æ–≤–µ—Ä–∫–∏ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏
```python
import hashlib
import base64
import subprocess
from nacl.signing import VerifyKey
from typing import Optional

def sha256_checksum(file_path: str) -> str:
    """–í—ã—á–∏—Å–ª–µ–Ω–∏–µ SHA256 —Ö–µ—à–∞ —Ñ–∞–π–ª–∞"""
    sha256_hash = hashlib.sha256()
    with open(file_path, "rb") as f:
        for chunk in iter(lambda: f.read(4096), b""):
            sha256_hash.update(chunk)
    return sha256_hash.hexdigest()

def verify_ed25519_signature(file_path: str, signature_b64: str, public_key_b64: str) -> bool:
    """–ü—Ä–æ–≤–µ—Ä–∫–∞ Ed25519 –ø–æ–¥–ø–∏—Å–∏"""
    try:
        with open(file_path, "rb") as f:
            data = f.read()
        
        verify_key = VerifyKey(base64.b64decode(public_key_b64))
        signature = base64.b64decode(signature_b64)
        verify_key.verify(data, signature)
        return True
    except Exception:
        return False

def verify_app_signature(app_path: str) -> bool:
    """–ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–¥–ø–∏—Å–∏ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è"""
    try:
        subprocess.check_call([
            "/usr/bin/codesign", "--verify", "--deep", "--strict", "--verbose=2", app_path
        ], stdout=subprocess.DEVNULL, stderr=subprocess.DEVNULL)
        
        subprocess.check_call([
            "/usr/sbin/spctl", "-a", "-vv", "--type", "execute", app_path
        ], stdout=subprocess.DEVNULL, stderr=subprocess.DEVNULL)
        
        return True
    except subprocess.CalledProcessError:
        return False
```

### **2.2 –ú–æ–¥—É–ª–∏ —Ä–∞–±–æ—Ç—ã —Å —Ñ–∞–π–ª–∞–º–∏**

#### **dmg.py** - –†–∞–±–æ—Ç–∞ —Å DMG —Ñ–∞–π–ª–∞–º–∏
```python
import subprocess
import os
import tempfile
from typing import Optional

def mount_dmg(dmg_path: str) -> str:
    """–ú–æ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ DMG —Ñ–∞–π–ª–∞"""
    mount_point = tempfile.mkdtemp(prefix="nexy_mount_")
    subprocess.check_call([
        "/usr/bin/hdiutil", "attach", "-nobrowse", "-mountpoint", mount_point, dmg_path
    ])
    return mount_point

def unmount_dmg(mount_point: str):
    """–†–∞–∑–º–æ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ DMG"""
    subprocess.check_call(["/usr/bin/hdiutil", "detach", mount_point])

def find_app_in_dmg(mount_point: str, app_name: str = "Nexy.app") -> Optional[str]:
    """–ü–æ–∏—Å–∫ .app —Ñ–∞–π–ª–∞ –≤ DMG"""
    app_path = os.path.join(mount_point, app_name)
    if os.path.isdir(app_path):
        return app_path
    
    for root, dirs, files in os.walk(mount_point):
        for dir_name in dirs:
            if dir_name.endswith(".app"):
                return os.path.join(root, dir_name)
    
    return None
```

#### **replace.py** - –ê—Ç–æ–º–∞—Ä–Ω–∞—è –∑–∞–º–µ–Ω–∞
```python
import os
import shutil
import subprocess

def atomic_replace_app(new_app_path: str, target_app_path: str):
    """–ê—Ç–æ–º–∞—Ä–Ω–∞—è –∑–∞–º–µ–Ω–∞ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è —Å –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å—é –æ—Ç–∫–∞—Ç–∞"""
    backup_path = target_app_path + ".backup"
    
    if os.path.exists(backup_path):
        shutil.rmtree(backup_path, ignore_errors=True)
    
    os.rename(target_app_path, backup_path)
    
    try:
        subprocess.check_call(["/usr/bin/ditto", new_app_path, target_app_path])
        shutil.rmtree(backup_path, ignore_errors=True)
        print("‚úÖ –ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ —É—Å–ø–µ—à–Ω–æ –æ–±–Ω–æ–≤–ª–µ–Ω–æ")
    except Exception as e:
        if os.path.exists(target_app_path):
            shutil.rmtree(target_app_path, ignore_errors=True)
        os.rename(backup_path, target_app_path)
        print(f"‚ùå –û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è, –≤—ã–ø–æ–ª–Ω–µ–Ω –æ—Ç–∫–∞—Ç: {e}")
        raise
```

### **2.3 –ú–∏–≥—Ä–∞—Ü–∏—è –∏ –æ—Å–Ω–æ–≤–Ω–∞—è –ª–æ–≥–∏–∫–∞**

#### **migrate.py** - –ú–∏–≥—Ä–∞—Ü–∏—è –≤ ~/Applications
```python
import os
import subprocess
from pathlib import Path

def get_current_app_path() -> str:
    """–ü–æ–ª—É—á–µ–Ω–∏–µ –ø—É—Ç–∏ –∫ —Ç–µ–∫—É—â–µ–º—É –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—é"""
    try:
        from Cocoa import NSBundle
        bundle_path = NSBundle.mainBundle().bundlePath()
        if bundle_path and bundle_path.endswith(".app"):
            return bundle_path
    except ImportError:
        pass
    
    return "/Applications/Nexy.app"

def get_user_app_path() -> str:
    """–ü–æ–ª—É—á–µ–Ω–∏–µ –ø—É—Ç–∏ –∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–æ–π –ø–∞–ø–∫–µ Applications"""
    user_home = Path.home()
    user_apps = user_home / "Applications"
    user_apps.mkdir(exist_ok=True)
    return str(user_apps / "Nexy.app")

def migrate_to_user_directory() -> bool:
    """–ú–∏–≥—Ä–∞—Ü–∏—è –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è –≤ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫—É—é –ø–∞–ø–∫—É"""
    current_path = get_current_app_path()
    user_path = get_user_app_path()
    
    if os.path.realpath(current_path) == os.path.realpath(user_path):
        return False
    
    print(f"üîÑ –ú–∏–≥—Ä–∞—Ü–∏—è –∏–∑ {current_path} –≤ {user_path}")
    
    if os.path.exists(user_path):
        shutil.rmtree(user_path, ignore_errors=True)
    
    subprocess.check_call(["/usr/bin/ditto", current_path, user_path])
    subprocess.Popen(["/usr/bin/open", "-a", user_path])
    os._exit(0)
    
    return True
```

#### **updater.py** - –û—Å–Ω–æ–≤–Ω–∞—è –ª–æ–≥–∏–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π
```python
import json
import tempfile
import os
import subprocess
from typing import Optional, Dict, Any
from .config import UpdaterConfig
from .net import UpdateHTTPClient
from .verify import sha256_checksum, verify_ed25519_signature, verify_app_signature
from .dmg import mount_dmg, unmount_dmg, find_app_in_dmg
from .replace import atomic_replace_app
from .migrate import get_user_app_path

class Updater:
    def __init__(self, config: UpdaterConfig):
        self.config = config
        self.http_client = UpdateHTTPClient(config.timeout, config.retries)
    
    def get_current_build(self) -> int:
        """–ü–æ–ª—É—á–µ–Ω–∏–µ —Ç–µ–∫—É—â–µ–≥–æ –Ω–æ–º–µ—Ä–∞ —Å–±–æ—Ä–∫–∏"""
        try:
            import plistlib
            info_plist_path = os.path.join(get_user_app_path(), "Contents", "Info.plist")
            with open(info_plist_path, "rb") as f:
                plist = plistlib.load(f)
            return int(plist.get("CFBundleVersion", 0))
        except Exception:
            return 0
    
    def check_for_updates(self) -> Optional[Dict[str, Any]]:
        """–ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π"""
        try:
            manifest = self.http_client.get_manifest(self.config.manifest_url)
            current_build = self.get_current_build()
            latest_build = int(manifest.get("build", 0))
            
            if latest_build > current_build:
                return manifest
            return None
        except Exception as e:
            print(f"‚ùå –û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π: {e}")
            return None
    
    def update(self) -> bool:
        """–ü–æ–ª–Ω—ã–π —Ü–∏–∫–ª –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è"""
        try:
            manifest = self.check_for_updates()
            if not manifest:
                return False
            
            print(f"üîÑ –ù–∞–π–¥–µ–Ω–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –¥–æ –≤–µ—Ä—Å–∏–∏ {manifest.get('version')}")
            
            # –°–∫–∞—á–∏–≤–∞–µ–º –∏ –ø—Ä–æ–≤–µ—Ä—è–µ–º
            artifact_info = manifest["artifact"]
            temp_file = self._download_and_verify(artifact_info)
            
            # –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º
            self._install_update(temp_file, artifact_info)
            
            # –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞–µ–º
            self._relaunch_app()
            
            return True
            
        except Exception as e:
            print(f"‚ùå –û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è: {e}")
            return False
```

---

## üîå –≠—Ç–∞–ø 3: –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å EventBus (30 –º–∏–Ω—É—Ç)

### **3.1 UpdaterIntegration**
```python
# client/integration/integrations/updater_integration.py
import asyncio
import logging
from typing import Dict, Any

from core.event_bus import EventBus, EventPriority
from core.state_manager import ApplicationStateManager
from modules.updater import Updater, UpdaterConfig, migrate_to_user_directory

logger = logging.getLogger(__name__)

class UpdaterIntegration:
    def __init__(self, event_bus: EventBus, state_manager: ApplicationStateManager, config: Dict[str, Any]):
        self.event_bus = event_bus
        self.state_manager = state_manager
        
        updater_config = UpdaterConfig(
            enabled=config.get("enabled", True),
            manifest_url=config.get("manifest_url", ""),
            check_interval=config.get("check_interval", 3600),
            auto_install=config.get("auto_install", True),
            public_key=config.get("security", {}).get("public_key", ""),
            timeout=config.get("timeout", 20),
            retries=config.get("retries", 3)
        )
        
        self.updater = Updater(updater_config)
        self.check_task = None
        self.is_running = False
    
    async def initialize(self) -> bool:
        """–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏"""
        try:
            logger.info("üîÑ –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è UpdaterIntegration...")
            
            # –ú–∏–≥—Ä–∞—Ü–∏—è –≤ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫—É—é –ø–∞–ø–∫—É (–æ–¥–∏–Ω —Ä–∞–∑)
            migrate_to_user_directory()
            
            await self._setup_event_handlers()
            logger.info("‚úÖ UpdaterIntegration –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω")
            return True
            
        except Exception as e:
            logger.error(f"‚ùå –û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ UpdaterIntegration: {e}")
            return False
    
    async def start(self) -> bool:
        """–ó–∞–ø—É—Å–∫ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏"""
        try:
            if not self.updater.config.enabled:
                logger.info("‚è≠Ô∏è –ü—Ä–æ–ø—É—Å–∫–∞—é –∑–∞–ø—É—Å–∫ UpdaterIntegration - –æ—Ç–∫–ª—é—á–µ–Ω")
                return True
            
            logger.info("üöÄ –ó–∞–ø—É—Å–∫ UpdaterIntegration...")
            self.check_task = asyncio.create_task(self._check_loop())
            self.is_running = True
            logger.info("‚úÖ UpdaterIntegration –∑–∞–ø—É—â–µ–Ω")
            return True
            
        except Exception as e:
            logger.error(f"‚ùå –û—à–∏–±–∫–∞ –∑–∞–ø—É—Å–∫–∞ UpdaterIntegration: {e}")
            return False
    
    async def _check_loop(self):
        """–¶–∏–∫–ª –ø—Ä–æ–≤–µ—Ä–∫–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π"""
        while self.is_running:
            try:
                if await self._can_update():
                    if self.updater.update():
                        return  # –ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –ø–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—Å—è
                
                await asyncio.sleep(self.updater.config.check_interval)
                
            except asyncio.CancelledError:
                break
            except Exception as e:
                logger.error(f"–û—à–∏–±–∫–∞ –≤ —Ü–∏–∫–ª–µ –ø—Ä–æ–≤–µ—Ä–∫–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π: {e}")
                await asyncio.sleep(300)
    
    async def _can_update(self) -> bool:
        """–ü—Ä–æ–≤–µ—Ä–∫–∞, –º–æ–∂–Ω–æ –ª–∏ –æ–±–Ω–æ–≤–ª—è—Ç—å—Å—è"""
        current_mode = self.state_manager.get_current_mode()
        return current_mode not in ["LISTENING", "PROCESSING"]
    
    async def _setup_event_handlers(self):
        """–ù–∞—Å—Ç—Ä–æ–π–∫–∞ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤ —Å–æ–±—ã—Ç–∏–π"""
        await self.event_bus.subscribe("app.startup", self._on_app_startup, EventPriority.MEDIUM)
        await self.event_bus.subscribe("app.shutdown", self._on_app_shutdown, EventPriority.HIGH)
        await self.event_bus.subscribe("updater.check_manual", self._on_manual_check, EventPriority.HIGH)
    
    async def _on_app_startup(self, event_data):
        logger.info("üöÄ –û–±—Ä–∞–±–æ—Ç–∫–∞ –∑–∞–ø—É—Å–∫–∞ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è –≤ UpdaterIntegration")
    
    async def _on_app_shutdown(self, event_data):
        logger.info("üõë –û–±—Ä–∞–±–æ—Ç–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è –≤ UpdaterIntegration")
        await self.stop()
    
    async def _on_manual_check(self, event_data):
        logger.info("üîç –†—É—á–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π")
        if await self._can_update():
            self.updater.update()
    
    async def stop(self):
        if self.check_task:
            self.check_task.cancel()
        self.is_running = False
        logger.info("‚úÖ UpdaterIntegration –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω")
```

### **3.2 –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ SimpleModuleCoordinator**
```python
# client/integration/core/simple_module_coordinator.py
# –î–æ–±–∞–≤–∏—Ç—å –≤ —Å–ø–∏—Å–æ–∫ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–π:
from integrations.updater_integration import UpdaterIntegration

# –í –º–µ—Ç–æ–¥–µ initialize_integrations():
if "updater" in self.config:
    integration = UpdaterIntegration(
        self.event_bus, 
        self.state_manager, 
        self.config["updater"]
    )
    await integration.initialize()
    self.integrations["updater"] = integration
```

---

## üñ•Ô∏è –≠—Ç–∞–ø 4: –°–µ—Ä–≤–µ—Ä–Ω–∞—è —á–∞—Å—Ç—å (1 —á–∞—Å)

### **4.1 JSON –º–∞–Ω–∏—Ñ–µ—Å—Ç**
```json
{
  "version": "2.6.0",
  "build": 20600,
  "release_date": "2025-09-19T10:00:00Z",
  "artifact": {
    "type": "dmg",
    "url": "https://updates.nexy.ai/Nexy-2.6.0.dmg",
    "size": 12345678,
    "sha256": "a1b2c3d4e5f6...",
    "ed25519": "BASE64_SIGNATURE_HERE",
    "arch": "universal2",
    "min_os": "11.0"
  },
  "notes_url": "https://nexy.ai/changelog/2.6.0"
}
```

### **4.2 –°–∫—Ä–∏–ø—Ç—ã —Å–±–æ—Ä–∫–∏**

#### **make_dmg.sh**
```bash
#!/bin/bash
# –°–æ–∑–¥–∞–Ω–∏–µ DMG —Ñ–∞–π–ª–∞

APP_PATH="dist/Nexy.app"
DMG_PATH="dist/Nexy-${VERSION}.dmg"

# –°–æ–∑–¥–∞–µ–º DMG
create-dmg --volname "Nexy ${VERSION}" \
  --window-size 480 320 \
  --app-drop-link 240 170 \
  --overwrite \
  "$DMG_PATH" \
  "$APP_PATH"

echo "‚úÖ DMG —Å–æ–∑–¥–∞–Ω: $DMG_PATH"
```

#### **sign_ed25519.py**
```python
#!/usr/bin/env python3
import base64
import sys
from nacl.signing import SigningKey

def sign_file(file_path: str, private_key_b64: str) -> str:
    """–ü–æ–¥–ø–∏—Å–∞–Ω–∏–µ —Ñ–∞–π–ª–∞ Ed25519 –∫–ª—é—á–æ–º"""
    with open(file_path, "rb") as f:
        data = f.read()
    
    signing_key = SigningKey(base64.b64decode(private_key_b64))
    signature = signing_key.sign(data)
    
    return base64.b64encode(signature.signature).decode("utf-8")

if __name__ == "__main__":
    if len(sys.argv) != 3:
        print("Usage: python sign_ed25519.py <file_path> <private_key_b64>")
        sys.exit(1)
    
    file_path = sys.argv[1]
    private_key_b64 = sys.argv[2]
    
    signature = sign_file(file_path, private_key_b64)
    print(signature)
```

### **4.3 –û–±–Ω–æ–≤–ª–µ–Ω–Ω—ã–π update_server.py**
```python
# server/update_server.py - –¥–æ–±–∞–≤–∏—Ç—å endpoint –¥–ª—è –º–∞–Ω–∏—Ñ–µ—Å—Ç–∞
async def manifest_handler(self, request):
    """–û–±—Ä–∞–±–æ—Ç—á–∏–∫ –º–∞–Ω–∏—Ñ–µ—Å—Ç–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π"""
    try:
        manifest_file = self.updates_dir / "manifests" / "manifest.json"
        if manifest_file.exists():
            with open(manifest_file, 'r', encoding='utf-8') as f:
                manifest = json.load(f)
            
            return web.json_response(
                manifest,
                headers={
                    'Cache-Control': 'no-cache, no-store, must-revalidate',
                    'Pragma': 'no-cache',
                    'Expires': '0'
                }
            )
        else:
            return web.Response(text="Manifest not found", status=404)
    except Exception as e:
        logger.error(f"‚ùå –û—à–∏–±–∫–∞ —á—Ç–µ–Ω–∏—è –º–∞–Ω–∏—Ñ–µ—Å—Ç–∞: {e}")
        return web.Response(text="Error reading manifest", status=500)

# –î–æ–±–∞–≤–∏—Ç—å –≤ create_app():
app.router.add_get('/manifest.json', self.manifest_handler)
```

---

## üß™ –≠—Ç–∞–ø 5: –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ (1 —á–∞—Å)

### **5.1 –õ–æ–∫–∞–ª—å–Ω–æ–µ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ**
```bash
# 1. –¢–µ—Å—Ç –º–∏–≥—Ä–∞—Ü–∏–∏
python -c "from modules.updater.migrate import migrate_to_user_directory; migrate_to_user_directory()"

# 2. –¢–µ—Å—Ç –ø—Ä–æ–≤–µ—Ä–∫–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π
python -c "from modules.updater.updater import Updater; u = Updater(config); print(u.check_for_updates())"

# 3. –¢–µ—Å—Ç —Å–∫–∞—á–∏–≤–∞–Ω–∏—è
python -c "from modules.updater.net import UpdateHTTPClient; c = UpdateHTTPClient(); c.download_file('http://example.com/test.dmg', '/tmp/test.dmg')"
```

### **5.2 –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏–æ–Ω–Ω—ã–µ —Ç–µ—Å—Ç—ã**
```python
# client/modules/updater/test_updater.py
import unittest
from unittest.mock import Mock, patch
from .updater import Updater
from .config import UpdaterConfig

class TestUpdater(unittest.TestCase):
    def setUp(self):
        self.config = UpdaterConfig(
            manifest_url="http://localhost:8081/manifest.json",
            enabled=True
        )
        self.updater = Updater(self.config)
    
    def test_check_for_updates(self):
        with patch.object(self.updater.http_client, 'get_manifest') as mock_get:
            mock_get.return_value = {
                "version": "2.6.0",
                "build": 20600,
                "artifact": {"type": "dmg", "url": "http://test.com/test.dmg"}
            }
            
            result = self.updater.check_for_updates()
            self.assertIsNotNone(result)
            self.assertEqual(result["version"], "2.6.0")

if __name__ == "__main__":
    unittest.main()
```

---

## üìã –ß–µ–∫-–ª–∏—Å—Ç –≤–Ω–µ–¥—Ä–µ–Ω–∏—è

### **–ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞**
- [ ] –°–æ–∑–¥–∞—Ç—å —Å—Ç—Ä—É–∫—Ç—É—Ä—É –ø–∞–ø–æ–∫ `client/modules/updater/`
- [ ] –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏: `urllib3`, `pynacl`, `packaging`
- [ ] –û–±–Ω–æ–≤–∏—Ç—å `requirements.txt`
- [ ] –û–±–Ω–æ–≤–∏—Ç—å `unified_config.yaml`

### **–†–µ–∞–ª–∏–∑–∞—Ü–∏—è –º–æ–¥—É–ª–µ–π**
- [ ] –°–æ–∑–¥–∞—Ç—å `config.py` - –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è
- [ ] –°–æ–∑–¥–∞—Ç—å `net.py` - HTTP –∫–ª–∏–µ–Ω—Ç
- [ ] –°–æ–∑–¥–∞—Ç—å `verify.py` - –ø—Ä–æ–≤–µ—Ä–∫–∏ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏
- [ ] –°–æ–∑–¥–∞—Ç—å `dmg.py` - —Ä–∞–±–æ—Ç–∞ —Å DMG
- [ ] –°–æ–∑–¥–∞—Ç—å `replace.py` - –∞—Ç–æ–º–∞—Ä–Ω–∞—è –∑–∞–º–µ–Ω–∞
- [ ] –°–æ–∑–¥–∞—Ç—å `migrate.py` - –º–∏–≥—Ä–∞—Ü–∏—è
- [ ] –°–æ–∑–¥–∞—Ç—å `updater.py` - –æ—Å–Ω–æ–≤–Ω–∞—è –ª–æ–≥–∏–∫–∞

### **–ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è**
- [ ] –°–æ–∑–¥–∞—Ç—å `updater_integration.py`
- [ ] –û–±–Ω–æ–≤–∏—Ç—å `simple_module_coordinator.py`
- [ ] –ó–∞–º–µ–Ω–∏—Ç—å `UpdateManagerIntegration` –Ω–∞ `UpdaterIntegration`

### **–°–µ—Ä–≤–µ—Ä–Ω–∞—è —á–∞—Å—Ç—å**
- [ ] –°–æ–∑–¥–∞—Ç—å `manifest.json`
- [ ] –°–æ–∑–¥–∞—Ç—å —Å–∫—Ä–∏–ø—Ç—ã —Å–±–æ—Ä–∫–∏
- [ ] –û–±–Ω–æ–≤–∏—Ç—å `update_server.py`

### **–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ**
- [ ] –õ–æ–∫–∞–ª—å–Ω—ã–µ —Ç–µ—Å—Ç—ã –º–æ–¥—É–ª–µ–π
- [ ] –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏–æ–Ω–Ω—ã–µ —Ç–µ—Å—Ç—ã
- [ ] –¢–µ—Å—Ç –ø–æ–ª–Ω–æ–≥–æ —Ü–∏–∫–ª–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è

### **–†–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏–µ**
- [ ] –°–±–æ—Ä–∫–∞ –ø–µ—Ä–≤–æ–≥–æ DMG
- [ ] –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –∫–ª—é—á–µ–π Ed25519
- [ ] –ü–æ–¥–ø–∏—Å–∞–Ω–∏–µ –∞—Ä—Ç–µ—Ñ–∞–∫—Ç–æ–≤
- [ ] –†–∞–∑–º–µ—â–µ–Ω–∏–µ –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ

---

## ‚ö†Ô∏è –í–∞–∂–Ω—ã–µ –º–æ–º–µ–Ω—Ç—ã

### **–ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å**
- ‚úÖ –í—Å–µ–≥–¥–∞ –ø—Ä–æ–≤–µ—Ä—è–π—Ç–µ SHA256 —Ö–µ—à
- ‚úÖ –û–±—è–∑–∞—Ç–µ–ª—å–Ω–æ –ø—Ä–æ–≤–µ—Ä—è–π—Ç–µ Ed25519 –ø–æ–¥–ø–∏—Å—å
- ‚úÖ –ü—Ä–æ–≤–µ—Ä—è–π—Ç–µ codesign –∏ spctl
- ‚úÖ –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ HTTPS –¥–ª—è –≤—Å–µ—Ö –∑–∞–ø—Ä–æ—Å–æ–≤

### **UX**
- ‚úÖ –ú–∏–≥—Ä–∞—Ü–∏—è –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø—Ä–∏ –ø–µ—Ä–≤–æ–º –∑–∞–ø—É—Å–∫–µ
- ‚úÖ –û–±–Ω–æ–≤–ª–µ–Ω–∏—è –Ω–µ –±–ª–æ–∫–∏—Ä—É—é—Ç —Ä–∞–±–æ—Ç—É –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
- ‚úÖ –ü–∞—Ä–æ–ª—å –∑–∞–ø—Ä–∞—à–∏–≤–∞–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –ø—Ä–∏ –ø–µ—Ä–≤–æ–π —É—Å—Ç–∞–Ω–æ–≤–∫–µ PKG

### **–û—Ç–ª–∞–¥–∫–∞**
- ‚úÖ –õ–æ–≥–∏ –≤ `~/Library/Logs/Nexy/updater.log`
- ‚úÖ –ü—Ä–æ–≤–µ—Ä—è–π—Ç–µ –ø—Ä–∞–≤–∞ –¥–æ—Å—Ç—É–ø–∞ –∫ `~/Applications`
- ‚úÖ –£–±–µ–¥–∏—Ç–µ—Å—å –≤ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ—Å—Ç–∏ –ø—É—Ç–µ–π –∫ .app —Ñ–∞–π–ª–∞–º

---

## üéØ –û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç

–ü–æ—Å–ª–µ –≤–Ω–µ–¥—Ä–µ–Ω–∏—è —Å–∏—Å—Ç–µ–º–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π –±—É–¥–µ—Ç:
- ‚úÖ **–†–∞–±–æ—Ç–∞—Ç—å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏** –±–µ–∑ –≤–º–µ—à–∞—Ç–µ–ª—å—Å—Ç–≤–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
- ‚úÖ **–ù–µ —Ç—Ä–µ–±–æ–≤–∞—Ç—å –ø–∞—Ä–æ–ª—å** –ø–æ—Å–ª–µ –ø–µ—Ä–≤–æ–π —É—Å—Ç–∞–Ω–æ–≤–∫–∏
- ‚úÖ **–ë—ã—Ç—å –±–µ–∑–æ–ø–∞—Å–Ω–æ–π** —Å –º–Ω–æ–≥–æ—É—Ä–æ–≤–Ω–µ–≤–æ–π –ø—Ä–æ–≤–µ—Ä–∫–æ–π
- ‚úÖ **–ò–Ω—Ç–µ–≥—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è** —Å —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–π EventBus –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–æ–π
- ‚úÖ **–õ–æ–≥–∏—Ä–æ–≤–∞—Ç—å—Å—è** –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏ –∏ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞

**–í—Ä–µ–º—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏: 4-5 —á–∞—Å–æ–≤**  
**–°—Ç–∞—Ç—É—Å: –ì–æ—Ç–æ–≤ –∫ –Ω–µ–º–µ–¥–ª–µ–Ω–Ω–æ–º—É –≤–Ω–µ–¥—Ä–µ–Ω–∏—é**
