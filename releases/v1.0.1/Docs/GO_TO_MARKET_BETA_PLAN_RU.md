## План вывода в тестовую бету (macOS) — простой и понятный

Документ описывает, что именно выпускаем, по каким шагам двигаемся, когда считаем этап «закрыт», и что проверяем у тестеров. Монетизации и лимитов сейчас нет — цель: быстро дать рабочую бета‑сборку, собрать обратную связь, не нарушая приватность.

### 1) Что получает тестер
- Приложение в меню‑баре macOS с 3 режимами: SLEEPING (серый), LISTENING (синий), PROCESSING (желтый).
- Push‑to‑Talk: удержание Space — слушает; отпустили — думает и вслух отвечает.
- 3 сценария «из коробки»: описать экран, картинку, график.
- Приватность: скриншоты не сохраняются на диск, данные только на время ответа.

### 2) Цели беты и критерии успеха (KPI)
- Функциональность: 10/10 успешных полных циклов «нажал — ответ — возврат» без падений.
- Скорость: первый звук (TTV) ≤ 5 секунд; полный ответ ≤ 30 секунд.
- Пользовательские сценарии: ≥80% тестеров выполняют 3 базовых задания.
- Стабильность: нет гонок состояний; прерывание останавливает воспроизведение.

### 2.1) Принятые параметры беты (уточнения)
- Волны тестеров: 5 → 10 → 20 (постепенное расширение).
- Платформа: macOS на Apple Silicon (M1+) и выше.
- Горячая клавиша: основной — Space; резерв — Option+Space (на случай конфликтов с VoiceOver).
- VoiceOver: при входе в LISTENING — ставим на паузу; при возврате в SLEEPING — возобновляем.
- Скриншоты: без доп. обработки/маскирования; формат WebP base64 по `streaming.proto`.
- Логи: включены; только тайминги/статусы/байты, без контента; локально, условная ретенция 7 дней (можно скорректировать).

---
### 3) Циклы (этапы) с критериями «ГОТОВО» (DoD)

#### Цикл 1 — Локальный клиент из исходников (без внешнего сервера)
Цель: запустить из кода стабильный цикл SLEEPING → LISTENING → PROCESSING → SLEEPING.

- Что делаем:
  - `client/main.py`: привязать event loop к EventBus (`attach_loop`) и опубликовать `app.startup`.
  - `SimpleModuleCoordinator`: реально вызывать `initialize()` и `start()` для `ListeningWorkflow` и `ProcessingWorkflow`.
  - Проверить PTT: удержание Space → LISTENING, отпускание → PROCESSING; резервный хоткей (Option+Space) при конфликте с VoiceOver.
  - Включить `HardwareIdIntegration`, `GrpcClientIntegration` (можно dev‑мок), `SpeechPlaybackIntegration`, `SignalIntegration`, `ModeManagementIntegration`.
  - Скриншоты: запрос разрешения Screen Recording; корректный размер (Retina/мульти‑монитор), кодировка base64 WebP.

- DoD (готово):
  - 10/10 прогонов: Space → запись → скриншот → ответ вслух → возврат в SLEEPING, без падений.
  - Оффлайн: корректное голосовое сообщение/поведение, без зависания в PROCESSING.
  - Логируется только служебная информация (тайминги/байты/статусы), без контента экрана.

#### Цикл 2 — PKG сборка, подпись и нотаризация
Цель: инсталлятор PKG, который ставится без предупреждений, с автообновлениями Sparkle.

- Что делаем:
  - Сборка через `client/packaging/Nexy.spec` / `build_final.sh`.
  - Подпись Developer ID Application/Installer (Team ID `5NKLL2CLB9`), `Bundle ID: com.nexy.assistant`, `entitlements.plist` (микрофон, экран, сеть, уведомления).
  - Нотаризация; Sparkle (тихий режим) с валидным appcast и EdDSA ключом.
  - Онбординг в меню: горячая клавиша, 3 подсказки, ссылка на Privacy Policy.

- DoD (готово):
  - PKG устанавливается без Gatekeeper‑алертов; первый запуск запрашивает Mic/Screen и работает.
  - Sparkle обновляет приложение на тестовом канале; повторный запуск без повторных запросов прав.
  - Поведение из Цикла 1 сохраняется (10/10 успешных прогонов).

#### Цикл 3 — Удалённый сервер (Azure VM) и реальный gRPC
Цель: стабильный e2e с удалённым сервером.

- Что делаем:
  - Поднять `server/grpc_server.py` на Azure VM (IP 20.151.51.172), открыть порт, настроить процессы и логи.
  - Проверить совместимость по `server/streaming.proto`: клиент отправляет `prompt + screenshot(base64 WebP) + hardware_id`, сервер стримит текст/аудио (48 kHz mono int16) и завершает `end_message`.
  - `client/config/unified_config.yaml`: выставить `grpc_host`, `grpc_port`, `use_tls` (если нет домена с валидным сертификатом — временно без TLS на бете).
  - Таймауты/ретраи и корректное закрытие in‑flight задач при обрыве сети.

- DoD (готово):
  - 10/10 запросов завершаются `grpc.request_completed` и `playback.completed`.
  - TTV ≤ 5 с, полный ответ ≤ 30 с; оффлайн/восстановление сети — без «зависаний».
  - Прерывание во время ответа останавливает воспроизведение и возвращает в SLEEPING.

#### Цикл 4 — Закрытая бета с пользователями (US/CA, бесплатно)
Цель: выдать PKG тестерам, собрать фидбек и метрики.

- Что делаем:
  - Подготовить короткую инструкцию: как выдать разрешения, горячая клавиша, 3 примера запросов, куда писать фидбек (email/Discord).
  - Включить минимальную телеметрию событий: install, first_run, PTT, `recognition_completed`, `screenshot.captured`, `grpc.request_(started|completed|failed)`, `playback.(started|completed)`.
  - Организационно контролировать затраты Azure (маленькая когорта, тест в оговорённые часы).

- DoD (готово):
  - ≥80% тестеров успешно выполняют 3 задания; нет массовых падений.
  - Собраны TTV, успешность по сценариям, топ‑проблемы и предложения.

---
### 4) Технические требования (минимум)
- Клиент: macOS 13+, разрешения Microphone / Screen Recording / Input Monitoring / Notifications.
- Архитектура: события через EventBus; 3 режима (SLEEPING/LISTENING/PROCESSING) — без добавления новых.
- Форматы: скриншот — base64 WebP; аудио — 48 kHz, mono, int16; всегда публиковать `playback.completed`.
- Сервер: совместим с `server/streaming.proto`; грамотное завершение стрима `end_message`.
- Константы идентичности: фиксированные `Bundle ID` и `Team ID` на весь период беты (чтобы не сбивались разрешения).

### 5) Риски и как избежать
- Конфликт Space с VoiceOver → резервный хоткей (Option+Space) и подсказка в меню.
- TLS по IP (без домена) → временно `use_tls=false` на бете или использовать домен с валидным сертификатом.
- Retina/мульти‑монитор → валидация размеров и кодировки WebP, проверка на 2 экранах.
- «Мигающая» сеть → отменять in‑flight задачи, не зависать в PROCESSING, корректные ретраи и таймауты.
- TCC‑разрешения сбиваются при смене подписи/Bundle ID → не менять эти параметры до конца беты.

### 6) График (ориентир)
- Цикл 1: 1–2 дня
- Цикл 2: 1 день
- Цикл 3: 1–2 дня
- Цикл 4: 5–7 дней (сбор фидбека)

### 7) Чек‑лист перед раздачей PKG
- Локально: 10/10 успешных циклов, оффлайн/прерывание работают.
- PKG: чистая установка на 2–3 Mac, первый запуск ок, Sparkle обновляет.
- Сервер: 10/10 e2e, TTV ≤ 5 с, полный ответ ≤ 30 с.
- Приватность: скриншоты не сохраняются, логи без PII.
- Инструкция для тестеров готова, канал фидбека работает.

### 8) Материалы в репозитории
- Клиент: `client/main.py`, `client/integration/core/simple_module_coordinator.py`, `client/integration/integrations/*.py`, `client/config/unified_config.yaml`.
- Сервер: `server/grpc_server.py`, `server/streaming.proto`, `server/integrations/workflow_integrations/streaming_workflow_integration.py`.
- Пакетирование: `client/packaging/*`, Sparkle настройки.

— Этот документ — ориентир. Двигаемся по циклам, закрываем DoD каждого этапа, выпускаем PKG тестерам, собираем данные и быстро улучшаем.

---
## Обратное планирование (Этап 3 → Этап 2 → Этап 1)

Ниже — что должно быть «на входе» каждого этапа и детальный план действий без повторения уже описанных DoD. Для критериев «ГОТОВО» см. DoD соответствующих Циклов выше.

### Этап 3 — Тестирование с пользователями (закрытая бета)
- Критерии «ГОТОВО»: см. DoD Цикл 4.
- Что должно быть на входе:
  - Подписанный и нотарифицированный PKG с автообновлениями (см. DoD Цикл 2).
  - Реальный e2e с сервером на Azure, совместимость по `streaming.proto` (см. DoD Цикл 3).
  - Короткая инструкция (разрешения, горячая клавиша, 3 примера запросов) и канал фидбека.
- Детальный план реализации:
  1) Сформировать когорту 20–50 тестеров (US/CA accessibility) и собрать контакты.
  2) Подготовить набор материалов к рассылке: PKG, инструкция (PDF/Markdown), форма фидбека.
  3) Выпустить билд N на тестовый appcast Sparkle, прошить ссылку в письме.
  4) Провести «консьерж‑онбординг» 3 пилотам (экран‑шеринг) и зафиксировать первые проблемы.
  5) Разослать остальным; мониторить TTV/успешность/падения по минимальной телеметрии.
  6) Завести тикеты по топ‑проблемам, назначить мини‑спринт фиксов, выпустить билд N+1.
  7) Сформировать короткий отчёт по результатам беты (метрики, инсайты, след. шаги).

### Этап 2 — Подписанный PKG + удалённый сервер (e2e)
- Критерии «ГОТОВО»: см. DoD Цикл 2 (PKG) и DoD Цикл 3 (сервер/e2e).
- Что должно быть на входе:
  - Стабильный локальный e2e (см. DoD Цикл 1).
- Детальный план реализации (без дубляжа, учитываем, что упаковка уже есть):
  1) Верификация Packaging: проверить `entitlements.plist`, Team ID/Bundle ID неизменны, повторная нотаризация при нужных микроправках.
  2) Sparkle: опубликовать тестовый appcast, проверить скачивание и установку обновления из установленной версии.
  3) TCC‑потоки: пройти сценарий первого запуска (Mic/Screen/Input Monitoring/Notifications), убедиться, что после обновления разрешения не сбрасываются.
  4) Azure: развернуть `server/grpc_server.py` как сервис (systemd/pm2), открыть порт, включить ротацию логов.
  5) gRPC healthcheck: `grpc_host/port/use_tls` в `unified_config.yaml`; при SNI‑проблемах — временно `use_tls=false` или домен с валидным сертификатом.
  6) Smoke‑сценарии e2e: «экран/картинка/график» по 3 прогона; оффлайн/восстановление/прерывание.
  7) Производительность: снять TTV и длительность ответа; при превышении порогов — уменьшить размер/частоту чанков или оптимизировать обработку на сервере.

### Этап 1 — Локальный клиент из исходников (без внешнего сервера)
- Критерии «ГОТОВО»: см. DoD Цикл 1.
- Детальный план реализации:
  1) `client/main.py`: `EventBus.attach_loop(...)`, публикация `app.startup`, запуск `SimpleModuleCoordinator.run()`.
  2) `SimpleModuleCoordinator`: убедиться, что вызовы `initialize()`/`start()` реально выполняются для `ListeningWorkflow` и `ProcessingWorkflow`.
  3) PTT/режимы: проверить привязку удержания/отпускания Space к событиям LISTENING/PROCESSING; добавить резервный хоткей (Option+Space) в меню.
  4) Скриншот: запрос Screen Recording; сверить размеры (Retina/мульти‑монитор), кодировать в base64 WebP до отправки.
  5) Воспроизведение: гарантировать `playback.started` на первом аудиочанке и обязательный `playback.completed` в конце любой ветки.
  6) Оффлайн/ошибки: корректно публиковать `grpc.request_failed` и возвращаться в SLEEPING, не зависая в PROCESSING.
  7) Логи/приватность: оставить только тайминги/байты/коды статусов; не писать контент и скриншоты на диск.



