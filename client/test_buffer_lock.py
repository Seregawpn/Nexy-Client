#!/usr/bin/env python3
"""
–¢–µ—Å—Ç –≤—Ä–µ–º–µ–Ω–Ω–æ–π –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏ –±—É—Ñ–µ—Ä–∞ AudioPlayer
–ü—Ä–æ–≤–µ—Ä—è–µ—Ç, —á—Ç–æ –ø–æ—Å–ª–µ –ø—Ä–µ—Ä—ã–≤–∞–Ω–∏—è –Ω–æ–≤—ã–µ —á–∞–Ω–∫–∏ –Ω–µ –¥–æ–±–∞–≤–ª—è—é—Ç—Å—è –≤ —Ç–µ—á–µ–Ω–∏–µ –∑–∞–¥–∞–Ω–Ω–æ–≥–æ –≤—Ä–µ–º–µ–Ω–∏
"""

import time
import numpy as np
from audio_player import AudioPlayer

def test_buffer_lock():
    """–¢–µ—Å—Ç–∏—Ä—É–µ—Ç –≤—Ä–µ–º–µ–Ω–Ω—É—é –±–ª–æ–∫–∏—Ä–æ–≤–∫—É –±—É—Ñ–µ—Ä–∞ –ø–æ—Å–ª–µ –ø—Ä–µ—Ä—ã–≤–∞–Ω–∏—è."""
    print("üß™ –¢–µ—Å—Ç –≤—Ä–µ–º–µ–Ω–Ω–æ–π –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏ –±—É—Ñ–µ—Ä–∞ AudioPlayer")
    print("=" * 60)
    
    # –°–æ–∑–¥–∞–µ–º AudioPlayer
    audio_player = AudioPlayer()
    print("‚úÖ AudioPlayer —Å–æ–∑–¥–∞–Ω")
    
    # –°–æ–∑–¥–∞–µ–º —Ç–µ—Å—Ç–æ–≤—ã–π –∞—É–¥–∏–æ —á–∞–Ω–∫
    test_chunk = np.random.randint(-32768, 32767, 1000, dtype=np.int16)
    print(f"‚úÖ –¢–µ—Å—Ç–æ–≤—ã–π —á–∞–Ω–∫ —Å–æ–∑–¥–∞–Ω: {len(test_chunk)} —Å—ç–º–ø–ª–æ–≤")
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞—á–∞–ª—å–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ
    print(f"üìä –ù–∞—á–∞–ª—å–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ: queue={audio_player.audio_queue.qsize()}, buffer_locked={audio_player.is_buffer_locked()}")
    
    # –î–æ–±–∞–≤–ª—è–µ–º –ø–µ—Ä–≤—ã–π —á–∞–Ω–∫ (–¥–æ–ª–∂–µ–Ω –¥–æ–±–∞–≤–∏—Ç—å—Å—è)
    print("\nüîç –¢–µ—Å—Ç 1: –î–æ–±–∞–≤–ª–µ–Ω–∏–µ —á–∞–Ω–∫–∞ –î–û –ø—Ä–µ—Ä—ã–≤–∞–Ω–∏—è")
    audio_player.add_chunk(test_chunk)
    print(f"üìä –ü–æ—Å–ª–µ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è: queue={audio_player.audio_queue.qsize()}")
    
    # –°–∏–º—É–ª–∏—Ä—É–µ–º –ø—Ä–µ—Ä—ã–≤–∞–Ω–∏–µ
    print("\nüîç –¢–µ—Å—Ç 2: –°–∏–º—É–ª—è—Ü–∏—è –ø—Ä–µ—Ä—ã–≤–∞–Ω–∏—è")
    start_time = time.time()
    audio_player.clear_all_audio_data()
    clear_time = (time.time() - start_time) * 1000
    print(f"‚è±Ô∏è –í—Ä–µ–º—è –æ—á–∏—Å—Ç–∫–∏: {clear_time:.1f}ms")
    print(f"üìä –ü–æ—Å–ª–µ –æ—á–∏—Å—Ç–∫–∏: queue={audio_player.audio_queue.qsize()}")
    print(f"üîí –ë—É—Ñ–µ—Ä –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω: {audio_player.is_buffer_locked()}")
    
    # –ü—ã—Ç–∞–µ–º—Å—è –¥–æ–±–∞–≤–∏—Ç—å —á–∞–Ω–∫ —Å—Ä–∞–∑—É –ø–æ—Å–ª–µ –ø—Ä–µ—Ä—ã–≤–∞–Ω–∏—è
    print("\nüîç –¢–µ—Å—Ç 3: –ü–æ–ø—ã—Ç–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è —á–∞–Ω–∫–∞ —Å—Ä–∞–∑—É –ø–æ—Å–ª–µ –ø—Ä–µ—Ä—ã–≤–∞–Ω–∏—è")
    audio_player.add_chunk(test_chunk)
    print(f"üìä –ü–æ—Å–ª–µ –ø–æ–ø—ã—Ç–∫–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è: queue={audio_player.audio_queue.qsize()}")
    
    # –ñ–¥–µ–º –Ω–µ–º–Ω–æ–≥–æ –∏ –ø—Ä–æ–≤–µ—Ä—è–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏
    print("\nüîç –¢–µ—Å—Ç 4: –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–æ—Å—Ç–æ—è–Ω–∏—è –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏ —á–µ—Ä–µ–∑ 0.1 —Å–µ–∫—É–Ω–¥—ã")
    time.sleep(0.1)
    print(f"üîí –ë—É—Ñ–µ—Ä –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω: {audio_player.is_buffer_locked()}")
    
    # –ü—ã—Ç–∞–µ–º—Å—è –¥–æ–±–∞–≤–∏—Ç—å —á–∞–Ω–∫ —á–µ—Ä–µ–∑ 0.1 —Å–µ–∫—É–Ω–¥—ã
    print("\nüîç –¢–µ—Å—Ç 5: –ü–æ–ø—ã—Ç–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è —á–∞–Ω–∫–∞ —á–µ—Ä–µ–∑ 0.1 —Å–µ–∫—É–Ω–¥—ã")
    audio_player.add_chunk(test_chunk)
    print(f"üìä –ü–æ—Å–ª–µ –ø–æ–ø—ã—Ç–∫–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è: queue={audio_player.audio_queue.qsize()}")
    
    # –ñ–¥–µ–º –æ–∫–æ–Ω—á–∞–Ω–∏—è –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏
    print("\nüîç –¢–µ—Å—Ç 6: –û–∂–∏–¥–∞–Ω–∏–µ –æ–∫–æ–Ω—á–∞–Ω–∏—è –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏")
    while audio_player.is_buffer_locked():
        time.sleep(0.01)
        print(f"‚è≥ –û–∂–∏–¥–∞–Ω–∏–µ... {audio_player.buffer_lock_until - time.time():.2f}s –æ—Å—Ç–∞–ª–æ—Å—å")
    
    print("‚úÖ –ë–ª–æ–∫–∏—Ä–æ–≤–∫–∞ —Å–Ω—è—Ç–∞!")
    
    # –ü—ã—Ç–∞–µ–º—Å—è –¥–æ–±–∞–≤–∏—Ç—å —á–∞–Ω–∫ –ø–æ—Å–ª–µ —Å–Ω—è—Ç–∏—è –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏
    print("\nüîç –¢–µ—Å—Ç 7: –î–æ–±–∞–≤–ª–µ–Ω–∏–µ —á–∞–Ω–∫–∞ –ø–æ—Å–ª–µ —Å–Ω—è—Ç–∏—è –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏")
    audio_player.add_chunk(test_chunk)
    print(f"üìä –ü–æ—Å–ª–µ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è: queue={audio_player.audio_queue.qsize()}")
    
    # –§–∏–Ω–∞–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞
    print("\nüîç –§–∏–Ω–∞–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞:")
    print(f"üìä –û—á–µ—Ä–µ–¥—å: {audio_player.audio_queue.qsize()}")
    print(f"üîí –ë—É—Ñ–µ—Ä –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω: {audio_player.is_buffer_locked()}")
    
    if audio_player.audio_queue.qsize() == 1:
        print("‚úÖ –¢–ï–°–¢ –ü–†–û–ô–î–ï–ù: –í—Ä–µ–º–µ–Ω–Ω–∞—è –±–ª–æ–∫–∏—Ä–æ–≤–∫–∞ —Ä–∞–±–æ—Ç–∞–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ!")
    else:
        print("‚ùå –¢–ï–°–¢ –ü–†–û–í–ê–õ–ï–ù: –í—Ä–µ–º–µ–Ω–Ω–∞—è –±–ª–æ–∫–∏—Ä–æ–≤–∫–∞ –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç!")
    
    print("=" * 60)

if __name__ == "__main__":
    test_buffer_lock()
