#!/bin/bash
set -euo pipefail

echo "üöÄ Postinstall: —É—Å—Ç–∞–Ω–æ–≤–∫–∞ Nexy AI Assistant"

# –û–ø—Ä–µ–¥–µ–ª—è–µ–º –∫–æ–Ω—Å–æ–ª—å–Ω–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (–Ω–∞–¥–µ–∂–Ω—ã–π —Å–ø–æ—Å–æ–±)
CONSOLE_USER="$(/usr/sbin/scutil <<< 'show State:/Users/ConsoleUser' | awk '/Name :/ && $3 != "loginwindow" { print $3 }')"
if [ -z "$CONSOLE_USER" ]; then
    echo "‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å –∫–æ–Ω—Å–æ–ª—å–Ω–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è"
    exit 1
fi

echo "üë§ –ö–æ–Ω—Å–æ–ª—å–Ω—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: $CONSOLE_USER"

# –ü–æ–ª—É—á–∞–µ–º –¥–æ–º–∞—à–Ω—é—é –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é
USER_HOME="$(dscl . -read /Users/"$CONSOLE_USER" NFSHomeDirectory | awk '{print $2}')"
if [ ! -d "$USER_HOME" ]; then
    echo "‚ùå –î–æ–º–∞—à–Ω—è—è –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—è –Ω–µ –Ω–∞–π–¥–µ–Ω–∞: $USER_HOME"
    exit 1
fi

# –ü–æ–ª—É—á–∞–µ–º UID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
USER_UID="$(id -u "$CONSOLE_USER")"
echo "üÜî UID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è: $USER_UID"

# –ü—É—Ç–∏ –∫ —Ñ–∞–π–ª–∞–º
APP_SRC="/usr/local/nexy/Nexy.app"
APP_DST="$USER_HOME/Applications/Nexy.app"
AGENT_SRC="/usr/local/nexy/resources/com.nexy.assistant.plist"
AGENT_DST="$USER_HOME/Library/LaunchAgents/com.nexy.assistant.plist"

# –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ –∏—Å—Ö–æ–¥–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤
if [ ! -d "$APP_SRC" ]; then
    echo "‚ùå –ò—Å—Ö–æ–¥–Ω–æ–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ: $APP_SRC"
    exit 1
fi

if [ ! -f "$AGENT_SRC" ]; then
    echo "‚ùå LaunchAgent –Ω–µ –Ω–∞–π–¥–µ–Ω: $AGENT_SRC"
    exit 1
fi

# –°–æ–∑–¥–∞–µ–º –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã–µ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏
echo "üìÅ –°–æ–∑–¥–∞–Ω–∏–µ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–π..."
mkdir -p "$USER_HOME/Applications" "$USER_HOME/Library/LaunchAgents" "$USER_HOME/Library/Logs"

# –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å—Ç–∞—Ä—ã–π –∞–≥–µ–Ω—Ç, –µ—Å–ª–∏ –±—ã–ª
echo "‚èπÔ∏è –û—Å—Ç–∞–Ω–æ–≤–∫–∞ —Å—Ç–∞—Ä–æ–≥–æ –∞–≥–µ–Ω—Ç–∞..."
/bin/launchctl bootout "gui/$USER_UID" "$AGENT_DST" >/dev/null 2>&1 || true

# –ö–æ–ø–∏—Ä—É–µ–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –≤ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫—É—é –ø–∞–ø–∫—É Applications
echo "üì¶ –ö–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è..."
rm -rf "$APP_DST"
cp -R "$APP_SRC" "$APP_DST"
chown -R "$CONSOLE_USER":staff "$APP_DST"

# –ü–æ–¥—Å—Ç–∞–≤–ª—è–µ–º —Ä–µ–∞–ª—å–Ω—ã–µ –ø—É—Ç–∏ –≤ LaunchAgent
echo "üìã –ù–∞—Å—Ç—Ä–æ–π–∫–∞ LaunchAgent..."
sed "s|%APP_PATH%|$APP_DST|g; s|%USER_HOME%|$USER_HOME|g" "$AGENT_SRC" > "$AGENT_DST"
chown "$CONSOLE_USER":staff "$AGENT_DST"

# –ó–∞–ø—É—Å–∫–∞–µ–º –∞–≥–µ–Ω—Ç –¥–ª—è GUI-—Å–µ—Å—Å–∏–∏
echo "üöÄ –ó–∞–ø—É—Å–∫ LaunchAgent..."
/bin/launchctl bootstrap "gui/$USER_UID" "$AGENT_DST" || true
/bin/launchctl enable "gui/$USER_UID/com.nexy.assistant" || true

# –ü—Ä–æ–≤–µ—Ä—è–µ–º –∑–∞–ø—É—Å–∫
sleep 2
if /bin/launchctl print "gui/$USER_UID" | grep -q "com.nexy.assistant"; then
    echo "‚úÖ LaunchAgent —É—Å–ø–µ—à–Ω–æ –∑–∞–ø—É—â–µ–Ω"
else
    echo "‚ö†Ô∏è LaunchAgent –º–æ–∂–µ—Ç –Ω–µ –∑–∞–ø—É—Å—Ç–∏—Ç—å—Å—è –¥–æ —Å–ª–µ–¥—É—é—â–µ–≥–æ –≤—Ö–æ–¥–∞ –≤ —Å–∏—Å—Ç–µ–º—É"
fi

echo "‚úÖ –£—Å—Ç–∞–Ω–æ–≤–∫–∞ Nexy AI Assistant –∑–∞–≤–µ—Ä—à–µ–Ω–∞"
echo "üìç –ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ –≤: $APP_DST"
echo "üîÑ –ê–≤—Ç–æ–∑–∞–ø—É—Å–∫ –Ω–∞—Å—Ç—Ä–æ–µ–Ω —á–µ—Ä–µ–∑ LaunchAgent"

exit 0
