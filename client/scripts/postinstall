#!/bin/bash
set -e

echo "üöÄ Postinstall: —É—Å—Ç–∞–Ω–æ–≤–∫–∞ Nexy AI Assistant"

# –ü—Ä–æ—Å—Ç–æ–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
CONSOLE_USER=$(stat -f%Su /dev/console)
USER_HOME=$(eval echo ~$CONSOLE_USER)

echo "üë§ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: $CONSOLE_USER"
echo "üè† –î–æ–º–∞—à–Ω—è—è –ø–∞–ø–∫–∞: $USER_HOME"

# –ü—É—Ç–∏ –∫ —Ñ–∞–π–ª–∞–º
APP_SRC="/usr/local/nexy/Nexy.app"
APP_DST="$USER_HOME/Applications/Nexy.app"
AGENT_SRC="/usr/local/nexy/resources/com.nexy.assistant.plist"
AGENT_DST="$USER_HOME/Library/LaunchAgents/com.nexy.assistant.plist"

# –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ –∏—Å—Ö–æ–¥–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤
if [ ! -d "$APP_SRC" ]; then
    echo "‚ùå –ò—Å—Ö–æ–¥–Ω–æ–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ: $APP_SRC"
    exit 1
fi

if [ ! -f "$AGENT_SRC" ]; then
    echo "‚ùå LaunchAgent –Ω–µ –Ω–∞–π–¥–µ–Ω: $AGENT_SRC"
    exit 1
fi

# –°–æ–∑–¥–∞–µ–º –ø–∞–ø–∫–∏
echo "üìÅ –°–æ–∑–¥–∞–Ω–∏–µ –ø–∞–ø–æ–∫..."
mkdir -p "$USER_HOME/Applications"
mkdir -p "$USER_HOME/Library/LaunchAgents"

# –ö–æ–ø–∏—Ä—É–µ–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ
echo "üì¶ –ö–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è..."
if [ -d "$APP_SRC" ]; then
    rm -rf "$APP_DST"
    cp -R "$APP_SRC" "$APP_DST"
    chown -R "$CONSOLE_USER":staff "$APP_DST"
    echo "‚úÖ –ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ"
else
    echo "‚ùå –ò—Å—Ö–æ–¥–Ω–æ–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ: $APP_SRC"
    exit 1
fi

# –ù–∞—Å—Ç—Ä–æ–π–∫–∞ LaunchAgent (—É–ø—Ä–æ—â–µ–Ω–Ω–æ)
if [ -f "$AGENT_SRC" ]; then
    echo "üìã –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –∞–≤—Ç–æ–∑–∞–ø—É—Å–∫–∞..."
    sed "s|%APP_PATH%|$APP_DST|g; s|%USER_HOME%|$USER_HOME|g" "$AGENT_SRC" > "$AGENT_DST"
    chown "$CONSOLE_USER":staff "$AGENT_DST"
    echo "‚úÖ LaunchAgent –Ω–∞—Å—Ç—Ä–æ–µ–Ω"
fi

echo "‚úÖ –£—Å—Ç–∞–Ω–æ–≤–∫–∞ Nexy AI Assistant –∑–∞–≤–µ—Ä—à–µ–Ω–∞"
echo "üìç –ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ –≤: $APP_DST"
echo "üîÑ –ê–≤—Ç–æ–∑–∞–ø—É—Å–∫ –Ω–∞—Å—Ç—Ä–æ–µ–Ω —á–µ—Ä–µ–∑ LaunchAgent"

exit 0
