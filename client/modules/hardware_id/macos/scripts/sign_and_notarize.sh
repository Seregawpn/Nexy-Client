#!/bin/bash

# –°–∫—Ä–∏–ø—Ç –¥–ª—è –ø–æ–¥–ø–∏—Å–∏ –∏ –Ω–æ—Ç–∞—Ä–∏–∑–∞—Ü–∏–∏ macOS –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
# –ó–∞–ø—É—Å–∫–∞—Ç—å –∏–∑ –∫–æ—Ä–Ω–µ–≤–æ–π –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ –ø—Ä–æ–µ–∫—Ç–∞ Nexy

# --- –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è ---
MODULE_NAME="hardware_id"
APP_NAME="NexyHardwareID"
DIST_DIR="./dist/${MODULE_NAME}"
APP_PATH="${DIST_DIR}/${APP_NAME}.app"
ENTITLEMENTS_FILE="./client/${MODULE_NAME}/macos/entitlements/${MODULE_NAME}.entitlements"
NOTARIZATION_CONFIG="./client/${MODULE_NAME}/macos/notarization/notarization_config.json"

# –ó–∞–≥—Ä—É–∑–∫–∞ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è –∏–∑ —Ñ–∞–π–ª–∞ .env (–µ—Å–ª–∏ –µ—Å—Ç—å)
if [ -f .env ]; then
    export $(grep -v '^#' .env | xargs)
fi

# –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞–ª–∏—á–∏—è –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã—Ö –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è
if [ -z "${APPLE_ID}" ] || [ -z "${APP_SPECIFIC_PASSWORD}" ] || [ -z "${TEAM_ID}" ] || [ -z "${DEVELOPER_ID_APPLICATION_CERT_NAME}" ]; then
    echo "‚ùå –û—à–∏–±–∫–∞: –ù–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è."
    echo "   –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ APPLE_ID, APP_SPECIFIC_PASSWORD, TEAM_ID –∏ DEVELOPER_ID_APPLICATION_CERT_NAME —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã."
    echo "   –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ —Ñ–∞–π–ª .env –∏–ª–∏ —ç–∫—Å–ø–æ—Ä—Ç–∏—Ä—É–π—Ç–µ –∏—Ö –≤—Ä—É—á–Ω—É—é."
    exit 1
fi

echo "üöÄ –ù–∞—á–∏–Ω–∞–µ–º –ø–æ–¥–ø–∏—Å—å –∏ –Ω–æ—Ç–∞—Ä–∏–∑–∞—Ü–∏—é –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è ${APP_NAME}..."

# 1. –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
if [ ! -d "${APP_PATH}" ]; then
    echo "‚ùå –û—à–∏–±–∫–∞: –ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ –ø–æ –ø—É—Ç–∏ ${APP_PATH}. –°–Ω–∞—á–∞–ª–∞ –≤—ã–ø–æ–ª–Ω–∏—Ç–µ —Å–±–æ—Ä–∫—É."
    exit 1
fi

# 2. –ü–æ–¥–ø–∏—Å—ã–≤–∞–µ–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ
echo "‚úçÔ∏è –ü–æ–¥–ø–∏—Å—ã–≤–∞–µ–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ —Å entitlements..."
codesign --force --deep --entitlements "${ENTITLEMENTS_FILE}" --options runtime --sign "${DEVELOPER_ID_APPLICATION_CERT_NAME}" "${APP_PATH}"

if [ $? -ne 0 ]; then
    echo "‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–¥–ø–∏—Å–∞–Ω–∏–∏ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è."
    exit 1
fi
echo "‚úÖ –ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ —É—Å–ø–µ—à–Ω–æ –ø–æ–¥–ø–∏—Å–∞–Ω–æ."

# 3. –ê—Ä—Ö–∏–≤–∏—Ä—É–µ–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –¥–ª—è –Ω–æ—Ç–∞—Ä–∏–∑–∞—Ü–∏–∏
echo "üì¶ –ê—Ä—Ö–∏–≤–∏—Ä—É–µ–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –¥–ª—è –Ω–æ—Ç–∞—Ä–∏–∑–∞—Ü–∏–∏..."
xcrun ditto -c -k --sequesterRsrc --keepParent "${APP_PATH}" "${APP_PATH}.zip"

if [ $? -ne 0 ]; then
    echo "‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –∞—Ä—Ö–∏–≤–∏—Ä–æ–≤–∞–Ω–∏–∏ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è."
    exit 1
fi
echo "‚úÖ –ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ —É—Å–ø–µ—à–Ω–æ –∑–∞–∞—Ä—Ö–∏–≤–∏—Ä–æ–≤–∞–Ω–æ: ${APP_PATH}.zip"

# 4. –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –Ω–∞ –Ω–æ—Ç–∞—Ä–∏–∑–∞—Ü–∏—é
echo "‚òÅÔ∏è –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –Ω–∞ –Ω–æ—Ç–∞—Ä–∏–∑–∞—Ü–∏—é..."
REQUEST_UUID=$(xcrun notarytool submit "${APP_PATH}.zip" \
    --apple-id "${APPLE_ID}" \
    --password "${APP_SPECIFIC_PASSWORD}" \
    --team-id "${TEAM_ID}" \
    --wait-for-completion | grep "id:" | awk '{print $NF}')

if [ $? -ne 0 ] || [ -z "${REQUEST_UUID}" ]; then
    echo "‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ –Ω–∞ –Ω–æ—Ç–∞—Ä–∏–∑–∞—Ü–∏—é –∏–ª–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ UUID –∑–∞–ø—Ä–æ—Å–∞."
    exit 1
fi
echo "‚úÖ –ó–∞–ø—Ä–æ—Å –Ω–∞ –Ω–æ—Ç–∞—Ä–∏–∑–∞—Ü–∏—é –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω. UUID: ${REQUEST_UUID}"

# 5. –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç–∞—Ç—É—Å –Ω–æ—Ç–∞—Ä–∏–∑–∞—Ü–∏–∏ (—É–∂–µ –≤–∫–ª—é—á–µ–Ω–æ –≤ --wait-for-completion)
# –ï—Å–ª–∏ --wait-for-completion –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç –∏–ª–∏ –Ω—É–∂–Ω–æ –±–æ–ª—å—à–µ –¥–µ—Ç–∞–ª–µ–π:
# echo "‚è≥ –û–∂–∏–¥–∞–µ–º –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –Ω–æ—Ç–∞—Ä–∏–∑–∞—Ü–∏–∏..."
# xcrun notarytool log "${REQUEST_UUID}" --apple-id "${APPLE_ID}" --password "${APP_SPECIFIC_PASSWORD}" --team-id "${TEAM_ID}" --output-format json > notary_log.json
# cat notary_log.json

# 6. –ü—Ä–∏–∫—Ä–µ–ø–ª—è–µ–º –±–∏–ª–µ—Ç Staple
echo "üìé –ü—Ä–∏–∫—Ä–µ–ø–ª—è–µ–º –±–∏–ª–µ—Ç Staple –∫ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—é..."
xcrun stapler staple "${APP_PATH}"

if [ $? -ne 0 ]; then
    echo "‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –ø—Ä–∏–∫—Ä–µ–ø–ª–µ–Ω–∏–∏ –±–∏–ª–µ—Ç–∞ Staple."
    exit 1
fi
echo "‚úÖ –ë–∏–ª–µ—Ç Staple —É—Å–ø–µ—à–Ω–æ –ø—Ä–∏–∫—Ä–µ–ø–ª–µ–Ω."

echo "üéâ –ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ ${APP_NAME} —É—Å–ø–µ—à–Ω–æ –ø–æ–¥–ø–∏—Å–∞–Ω–æ –∏ –Ω–æ—Ç–∞—Ä–∏–∑–æ–≤–∞–Ω–æ!"

# –û—á–∏—Å—Ç–∫–∞ –∞—Ä—Ö–∏–≤–∞
rm "${APP_PATH}.zip"
echo "üßπ –í—Ä–µ–º–µ–Ω–Ω—ã–π –∞—Ä—Ö–∏–≤ —É–¥–∞–ª–µ–Ω."

# 7. –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –ø–æ–¥–ø–∏—Å–∞–Ω–Ω–æ–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏
echo ""
echo "üìä –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –ø–æ–¥–ø–∏—Å–∞–Ω–Ω–æ–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏:"
echo "   - –ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ: ${APP_NAME}"
echo "   - –ü—É—Ç—å: ${APP_PATH}"
echo "   - Entitlements: ${ENTITLEMENTS_FILE}"
echo "   - –°—Ç–∞—Ç—É—Å: –ü–æ–¥–ø–∏—Å–∞–Ω–æ –∏ –Ω–æ—Ç–∞—Ä–∏–∑–æ–≤–∞–Ω–æ"
echo "   - UUID –∑–∞–ø—Ä–æ—Å–∞: ${REQUEST_UUID}"
