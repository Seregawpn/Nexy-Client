#!/bin/bash
# –ü–æ–ª–Ω–∞—è –ø–µ—Ä–µ—É–ø–∞–∫–æ–≤–∫–∞, –ø–æ–¥–ø–∏—Å–∞–Ω–∏–µ –∏ –Ω–æ—Ç–∞—Ä–∏–∑–∞—Ü–∏—è Nexy AI Voice Assistant

set -e

echo "üîÑ –ü–û–õ–ù–ê–Ø –ü–ï–†–ï–£–ü–ê–ö–û–í–ö–ê NEXY AI VOICE ASSISTANT"
echo "=============================================="

# –ü—Ä–æ–≤–µ—Ä–∫–∞, —á—Ç–æ –º—ã –≤ –ø—Ä–∞–≤–∏–ª—å–Ω–æ–π –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏
if [ ! -f "nexy.spec" ]; then
    echo "‚ùå –ó–∞–ø—É—Å—Ç–∏—Ç–µ —Å–∫—Ä–∏–ø—Ç –∏–∑ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ client/"
    exit 1
fi

# –≠—Ç–∞–ø 1: –û—á–∏—Å—Ç–∫–∞
echo ""
echo "üßπ –≠–¢–ê–ü 1: –û—á–∏—Å—Ç–∫–∞ –ø—Ä–µ–¥—ã–¥—É—â–∏—Ö —Å–±–æ—Ä–æ–∫"
echo "------------------------------------"
rm -rf build/ dist/ *.pkg
echo "‚úÖ –û—á–∏—Å—Ç–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞"

# –≠—Ç–∞–ø 2: –ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π
echo ""
echo "üîç –≠–¢–ê–ü 2: –ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π"
echo "--------------------------------"
./verify_packaging.sh
echo "‚úÖ –í—Å–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –ø—Ä–æ–≤–µ—Ä–µ–Ω—ã"

# –≠—Ç–∞–ø 3: –°–±–æ—Ä–∫–∞ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
echo ""
echo "üî® –≠–¢–ê–ü 3: –°–±–æ—Ä–∫–∞ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è"
echo "----------------------------"
echo "üì¶ –°–±–æ—Ä–∫–∞ —á–µ—Ä–µ–∑ PyInstaller..."
if python3 -m PyInstaller nexy.spec --clean --noconfirm; then
    echo "‚úÖ –ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ —Å–æ–±—Ä–∞–Ω–æ —É—Å–ø–µ—à–Ω–æ"
else
    echo "‚ùå –û—à–∏–±–∫–∞ —Å–±–æ—Ä–∫–∏ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è"
    exit 1
fi

# –ü—Ä–æ–≤–µ—Ä–∫–∞, —á—Ç–æ .app bundle —Å–æ–∑–¥–∞–Ω
if [ ! -d "dist/Nexy.app" ]; then
    echo "‚ùå .app bundle –Ω–µ –Ω–∞–π–¥–µ–Ω –ø–æ—Å–ª–µ —Å–±–æ—Ä–∫–∏"
    exit 1
fi

# –≠—Ç–∞–ø 4: –ü–æ–¥–ø–∏—Å—å Sparkle Framework (–µ—Å–ª–∏ –µ—Å—Ç—å)
echo ""
echo "üîê –≠–¢–ê–ü 4: –ü–æ–¥–ø–∏—Å—å Sparkle Framework"
echo "-----------------------------------"
if [ -f "sign_sparkle.sh" ]; then
    ./sign_sparkle.sh
    echo "‚úÖ Sparkle Framework –æ–±—Ä–∞–±–æ—Ç–∞–Ω"
else
    echo "‚ÑπÔ∏è Sparkle Framework –Ω–µ –Ω–∞–π–¥–µ–Ω (–ø—Ä–æ–ø—É—Å–∫–∞–µ–º)"
fi

# –≠—Ç–∞–ø 5: –°–æ–∑–¥–∞–Ω–∏–µ PKG
echo ""
echo "üì¶ –≠–¢–ê–ü 5: –°–æ–∑–¥–∞–Ω–∏–µ PKG —É—Å—Ç–∞–Ω–æ–≤—â–∏–∫–∞"
echo "-----------------------------------"
if ./create_pkg.sh; then
    echo "‚úÖ PKG —Å–æ–∑–¥–∞–Ω —É—Å–ø–µ—à–Ω–æ"
else
    echo "‚ùå –û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è PKG"
    exit 1
fi

# –ü—Ä–æ–≤–µ—Ä–∫–∞, —á—Ç–æ PKG —Å–æ–∑–¥–∞–Ω
if [ ! -f "Nexy_AI_Voice_Assistant_v1.71.0.pkg" ]; then
    echo "‚ùå PKG —Ñ–∞–π–ª –Ω–µ –Ω–∞–π–¥–µ–Ω –ø–æ—Å–ª–µ —Å–æ–∑–¥–∞–Ω–∏—è"
    exit 1
fi

# –≠—Ç–∞–ø 6: –ù–æ—Ç–∞—Ä–∏–∑–∞—Ü–∏—è
echo ""
echo "üîê –≠–¢–ê–ü 6: –ù–æ—Ç–∞—Ä–∏–∑–∞—Ü–∏—è PKG"
echo "--------------------------"
if ./notarize.sh Nexy_AI_Voice_Assistant_v1.71.0.pkg; then
    echo "‚úÖ PKG –Ω–æ—Ç–∞—Ä–∏–∑–æ–≤–∞–Ω —É—Å–ø–µ—à–Ω–æ"
else
    echo "‚ùå –û—à–∏–±–∫–∞ –Ω–æ—Ç–∞—Ä–∏–∑–∞—Ü–∏–∏"
    exit 1
fi

# –≠—Ç–∞–ø 7: –§–∏–Ω–∞–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞
echo ""
echo "‚úÖ –≠–¢–ê–ü 7: –§–∏–Ω–∞–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞"
echo "-----------------------------"
echo "üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–¥–ø–∏—Å–∏ PKG..."
if codesign --verify --verbose Nexy_AI_Voice_Assistant_v1.71.0.pkg; then
    echo "‚úÖ –ü–æ–¥–ø–∏—Å—å PKG –∫–æ—Ä—Ä–µ–∫—Ç–Ω–∞"
else
    echo "‚ö†Ô∏è –ü—Ä–æ–±–ª–µ–º—ã —Å –ø–æ–¥–ø–∏—Å—å—é PKG"
fi

echo "üìä –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ PKG:"
du -h Nexy_AI_Voice_Assistant_v1.71.0.pkg
pkgutil --check-signature Nexy_AI_Voice_Assistant_v1.71.0.pkg

echo ""
echo "üéâ –ü–ï–†–ï–£–ü–ê–ö–û–í–ö–ê –ó–ê–í–ï–†–®–ï–ù–ê –£–°–ü–ï–®–ù–û!"
echo "==================================="
echo "üì¶ –ì–æ—Ç–æ–≤—ã–π PKG: Nexy_AI_Voice_Assistant_v1.71.0.pkg"
echo "üì± –ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ: dist/Nexy.app"
echo ""
echo "üìã –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –ø—Ä–æ–¥—É–∫—Ç–µ:"
echo "   ‚Ä¢ –í–µ—Ä—Å–∏—è: 1.71.0"
echo "   ‚Ä¢ Bundle ID: com.sergiyzasorin.nexy.voiceassistant"
echo "   ‚Ä¢ –ü–æ–¥–ø–∏—Å—å: Developer ID Application/Installer"
echo "   ‚Ä¢ –ù–æ—Ç–∞—Ä–∏–∑–∞—Ü–∏—è: ‚úÖ –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∞ Apple"
echo "   ‚Ä¢ –†–∞–∑–º–µ—Ä: $(du -h Nexy_AI_Voice_Assistant_v1.71.0.pkg | cut -f1)"
echo ""
echo "üöÄ PKG –≥–æ—Ç–æ–≤ –∫ —Ä–∞—Å–ø—Ä–æ—Å—Ç—Ä–∞–Ω–µ–Ω–∏—é!"

