# –ú–∏–Ω–∏–º–∞–ª—å–Ω—ã–π Makefile –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
APP_NAME ?= Nexy
BUNDLE_ID ?= com.nexy.assistant
VERSION ?= 2.5.0
BUILD ?= 20500

DEVELOPER_ID_APP ?= Developer ID Application: Sergiy Zasorin (5NKLL2CLB9)
DEVELOPER_ID_INSTALLER ?= Developer ID Installer: Sergiy Zasorin (5NKLL2CLB9)

SPEC ?= Nexy.minimal.spec
DIST_APP := ../dist/$(APP_NAME).app

.PHONY: clean app sign test

clean:
	@echo "üßπ –û—á–∏—Å—Ç–∫–∞..."
	rm -rf build dist

app:
	@echo "üî® –°–±–æ—Ä–∫–∞ –º–∏–Ω–∏–º–∞–ª—å–Ω–æ–≥–æ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è..."
	cd .. && python3 -m PyInstaller --clean -y packaging/$(SPEC)
	@if [ -d "$(DIST_APP)" ]; then \
		echo "‚úÖ $(APP_NAME).app —Å–æ–∑–¥–∞–Ω"; \
	else \
		echo "‚ùå –û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è .app"; exit 1; \
	fi

sign:
	@echo "üîê –¢–µ—Å—Ç –ø–æ–¥–ø–∏—Å–∏..."
	@echo "1. –ü—Ä–æ–≤–µ—Ä—è–µ–º xattrs:"
	@xattr -l "$(DIST_APP)" || echo "–ù–µ—Ç xattrs"
	@echo ""
	@echo "2. –û—á–∏—â–∞–µ–º xattrs:"
	xattr -rc "$(DIST_APP)"
	@echo ""
	@echo "3. –ü—ã—Ç–∞–µ–º—Å—è –ø–æ–¥–ø–∏—Å–∞—Ç—å –ë–ï–ó entitlements:"
	codesign --force --sign "$(DEVELOPER_ID_APP)" "$(DIST_APP)/Contents/MacOS/$(APP_NAME)" 2>&1 && echo "‚úÖ –£—Å–ø–µ—Ö –ë–ï–ó entitlements" || echo "‚ùå –û—à–∏–±–∫–∞ –ë–ï–ó entitlements"
	@echo ""
	@echo "4. –ü—ã—Ç–∞–µ–º—Å—è –ø–æ–¥–ø–∏—Å–∞—Ç—å –° –º–∏–Ω–∏–º–∞–ª—å–Ω—ã–º–∏ entitlements:"
	codesign --force --entitlements entitlements.minimal.plist --sign "$(DEVELOPER_ID_APP)" "$(DIST_APP)/Contents/MacOS/$(APP_NAME)" 2>&1 && echo "‚úÖ –£—Å–ø–µ—Ö –° –º–∏–Ω–∏–º–∞–ª—å–Ω—ã–º–∏ entitlements" || echo "‚ùå –û—à–∏–±–∫–∞ –° –º–∏–Ω–∏–º–∞–ª—å–Ω—ã–º–∏ entitlements"
	@echo ""
	@echo "5. –ü—ã—Ç–∞–µ–º—Å—è –ø–æ–¥–ø–∏—Å–∞—Ç—å –≤–µ—Å—å .app –ë–ï–ó entitlements:"
	codesign --force --sign "$(DEVELOPER_ID_APP)" "$(DIST_APP)" 2>&1 && echo "‚úÖ –£—Å–ø–µ—Ö –ø–æ–¥–ø–∏—Å–∏ .app –ë–ï–ó entitlements" || echo "‚ùå –û—à–∏–±–∫–∞ –ø–æ–¥–ø–∏—Å–∏ .app –ë–ï–ó entitlements"

test: clean app sign
