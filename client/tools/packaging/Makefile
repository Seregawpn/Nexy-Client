# Makefile –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω–æ–π —Å–±–æ—Ä–∫–∏ Nexy PKG
# –û—Å–Ω–æ–≤–∞–Ω –Ω–∞ PACKAGING_PLAN.md

# –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è (–º–æ–∂–Ω–æ –ø–µ—Ä–µ–æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å)
VERSION ?= 2.5.0
BUILD ?= 20500
APP_NAME = Nexy
BUNDLE_ID = com.nexy.assistant
TEAM_ID = 5NKLL2CLB9

# –ü—É—Ç–∏
CLIENT_DIR = $(shell pwd)/..
PACKAGING_DIR = $(shell pwd)
BUILD_DIR = $(CLIENT_DIR)/build
DIST_DIR = $(CLIENT_DIR)/dist
APP_PATH = $(DIST_DIR)/$(APP_NAME).app
PKG_NAME = $(APP_NAME)-$(VERSION).pkg
SIGNED_PKG_NAME = $(APP_NAME)-$(VERSION)-signed.pkg

# –°–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç—ã (–Ω–∞—Å—Ç—Ä–æ–µ–Ω—ã)
DEVELOPER_ID_APP = "Developer ID Application: Sergiy Zasorin ($(TEAM_ID))"
DEVELOPER_ID_INSTALLER = "Developer ID Installer: Sergiy Zasorin ($(TEAM_ID))"
APPLE_NOTARY_PROFILE = "nexy-notary"

# Sparkle
SPARKLE_FRAMEWORK = /opt/homebrew/Caskroom/sparkle/2.7.1/Sparkle.framework

.PHONY: all clean app sign-app pkg sign-pkg notarize staple test-app help

# –û—Å–Ω–æ–≤–Ω—ã–µ —Ü–µ–ª–∏
all: clean app sign-app pkg sign-pkg notarize staple
	@echo "‚úÖ –ü–æ–ª–Ω–∞—è —Å–±–æ—Ä–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞: $(SIGNED_PKG_NAME)"

help:
	@echo "üîß –î–æ—Å—Ç—É–ø–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã:"
	@echo "  all          - –ü–æ–ª–Ω–∞—è —Å–±–æ—Ä–∫–∞: app ‚Üí –ø–æ–¥–ø–∏—Å—å ‚Üí pkg ‚Üí –Ω–æ—Ç–∞—Ä–∏–∑–∞—Ü–∏—è"
	@echo "  app          - –°–±–æ—Ä–∫–∞ .app —Å PyInstaller"
	@echo "  sign-app     - –ü–æ–¥–ø–∏—Å—å .app"
	@echo "  pkg          - –°–±–æ—Ä–∫–∞ .pkg"
	@echo "  sign-pkg     - –ü–æ–¥–ø–∏—Å—å .pkg"
	@echo "  notarize     - –ù–æ—Ç–∞—Ä–∏–∑–∞—Ü–∏—è .pkg"
	@echo "  staple       - –°—Ç–µ–ø–ª–∏–Ω–≥ .pkg"
	@echo "  test-app     - –¢–µ—Å—Ç–æ–≤—ã–π –∑–∞–ø—É—Å–∫ .app"
	@echo "  clean        - –û—á–∏—Å—Ç–∫–∞ –≤—Ä–µ–º–µ–Ω–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤"
	@echo ""
	@echo "üìã –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ:"
	@echo "  VERSION=$(VERSION)"
	@echo "  BUILD=$(BUILD)"
	@echo "  TEAM_ID=$(TEAM_ID)"

# –û—á–∏—Å—Ç–∫–∞
clean:
	@echo "üßπ –û—á–∏—Å—Ç–∫–∞ –≤—Ä–µ–º–µ–Ω–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤..."
	rm -rf $(BUILD_DIR) $(DIST_DIR)
	rm -f $(CLIENT_DIR)/*.pkg
	rm -f $(CLIENT_DIR)/*.dmg

# 1. –°–±–æ—Ä–∫–∞ .app
app: clean
	@echo "üî® –°–±–æ—Ä–∫–∞ $(APP_NAME).app..."
	cd $(CLIENT_DIR) && python3 -m PyInstaller --clean -y $(PACKAGING_DIR)/Nexy.spec
	@if [ -d "$(APP_PATH)" ]; then \
		echo "‚úÖ $(APP_NAME).app —É—Å–ø–µ—à–Ω–æ —Å–æ–∑–¥–∞–Ω"; \
	else \
		echo "‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ .app"; exit 1; \
	fi

# 2. –ü–æ–¥–ø–∏—Å—å .app
sign-app: app
	@echo "üîê –ü–æ–¥–ø–∏—Å—å –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è..."
	@# –ü–æ–¥–ø–∏—Å—ã–≤–∞–µ–º Sparkle Framework
	@if [ -d "$(APP_PATH)/Contents/Frameworks/Sparkle.framework" ]; then \
		echo "üìù –ü–æ–¥–ø–∏—Å—å Sparkle.framework..."; \
		codesign --force --options runtime --timestamp \
			--sign $(DEVELOPER_ID_APP) \
			"$(APP_PATH)/Contents/Frameworks/Sparkle.framework"; \
	fi
	@# –ü–æ–¥–ø–∏—Å—ã–≤–∞–µ–º –æ—Å–Ω–æ–≤–Ω–æ–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ
	@echo "üìù –ü–æ–¥–ø–∏—Å—å –æ—Å–Ω–æ–≤–Ω–æ–≥–æ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è..."
	@echo "üßπ –û—á–∏—Å—Ç–∫–∞ extended attributes..."
	xattr -cr "$(APP_PATH)"
	codesign --force --options runtime --timestamp \
		--entitlements $(PACKAGING_DIR)/entitlements.plist \
		--sign $(DEVELOPER_ID_APP) "$(APP_PATH)"
	@# –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–æ–¥–ø–∏—Å—å
	@echo "üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–¥–ø–∏—Å–∏..."
	codesign --verify --strict --verbose=2 "$(APP_PATH)"
	spctl --assess --type execute --verbose "$(APP_PATH)"
	@echo "‚úÖ –ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –ø–æ–¥–ø–∏—Å–∞–Ω–æ —É—Å–ø–µ—à–Ω–æ"

# 3. –¢–µ—Å—Ç–æ–≤—ã–π –∑–∞–ø—É—Å–∫
test-app: sign-app
	@echo "üß™ –¢–µ—Å—Ç–æ–≤—ã–π –∑–∞–ø—É—Å–∫ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è..."
	@echo "–ó–∞–ø—É—Å–∫ $(APP_PATH)..."
	open "$(APP_PATH)"
	@echo "‚è±Ô∏è –ü–æ–¥–æ–∂–¥–∏—Ç–µ 5 —Å–µ–∫—É–Ω–¥ –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –∑–∞–ø—É—Å–∫–∞..."
	sleep 5
	@echo "‚úÖ –¢–µ—Å—Ç –∑–∞–≤–µ—Ä—à–µ–Ω. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ, —á—Ç–æ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –∑–∞–ø—É—Å—Ç–∏–ª–æ—Å—å –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ"

# 4. –°–±–æ—Ä–∫–∞ PKG
pkg: sign-app
	@echo "üì¶ –°–±–æ—Ä–∫–∞ PKG..."
	productbuild \
		--component "$(APP_PATH)" /Applications \
		"$(CLIENT_DIR)/$(PKG_NAME)"
	@echo "‚úÖ PKG —Å–æ–∑–¥–∞–Ω: $(PKG_NAME)"

# 5. –ü–æ–¥–ø–∏—Å—å PKG
sign-pkg: pkg
	@echo "üîê –ü–æ–¥–ø–∏—Å—å PKG..."
	productsign \
		--sign $(DEVELOPER_ID_INSTALLER) \
		"$(CLIENT_DIR)/$(PKG_NAME)" \
		"$(CLIENT_DIR)/$(SIGNED_PKG_NAME)"
	@# –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–¥–ø–∏—Å–∏ PKG
	pkgutil --check-signature "$(CLIENT_DIR)/$(SIGNED_PKG_NAME)"
	@echo "‚úÖ PKG –ø–æ–¥–ø–∏—Å–∞–Ω: $(SIGNED_PKG_NAME)"

# 6. –ù–æ—Ç–∞—Ä–∏–∑–∞—Ü–∏—è
notarize: sign-pkg
	@echo "üåê –û—Ç–ø—Ä–∞–≤–∫–∞ –Ω–∞ –Ω–æ—Ç–∞—Ä–∏–∑–∞—Ü–∏—é..."
	@echo "‚è≥ –≠—Ç–æ –º–æ–∂–µ—Ç –∑–∞–Ω—è—Ç—å –Ω–µ—Å–∫–æ–ª—å–∫–æ –º–∏–Ω—É—Ç..."
	xcrun notarytool submit "$(CLIENT_DIR)/$(SIGNED_PKG_NAME)" \
		--keychain-profile $(APPLE_NOTARY_PROFILE) \
		--wait
	@echo "‚úÖ –ù–æ—Ç–∞—Ä–∏–∑–∞—Ü–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–∞"

# 7. –°—Ç–µ–ø–ª–∏–Ω–≥
staple: notarize
	@echo "üìé –°—Ç–µ–ø–ª–∏–Ω–≥ PKG..."
	xcrun stapler staple "$(CLIENT_DIR)/$(SIGNED_PKG_NAME)"
	@echo "‚úÖ PKG –≥–æ—Ç–æ–≤ –∫ —Ä–∞—Å–ø—Ä–æ—Å—Ç—Ä–∞–Ω–µ–Ω–∏—é: $(SIGNED_PKG_NAME)"

# –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏–π
check-requirements:
	@echo "üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏–π..."
	@python3 -c "import PyInstaller" >/dev/null 2>&1 || { echo "‚ùå PyInstaller –Ω–µ –Ω–∞–π–¥–µ–Ω. –£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ: pip install pyinstaller"; exit 1; }
	@command -v codesign >/dev/null 2>&1 || { echo "‚ùå codesign –Ω–µ –Ω–∞–π–¥–µ–Ω. –£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ Xcode Command Line Tools"; exit 1; }
	@command -v productbuild >/dev/null 2>&1 || { echo "‚ùå productbuild –Ω–µ –Ω–∞–π–¥–µ–Ω. –£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ Xcode Command Line Tools"; exit 1; }
	@command -v xcrun >/dev/null 2>&1 || { echo "‚ùå xcrun –Ω–µ –Ω–∞–π–¥–µ–Ω. –£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ Xcode Command Line Tools"; exit 1; }
	@if [ ! -d "$(SPARKLE_FRAMEWORK)" ]; then \
		echo "‚ùå Sparkle.framework –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ $(SPARKLE_FRAMEWORK)"; \
		echo "   –£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ: brew install --cask sparkle"; \
		exit 1; \
	fi
	@echo "‚úÖ –í—Å–µ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è –≤—ã–ø–æ–ª–Ω–µ–Ω—ã"

# –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–∞—Ö
cert-info:
	@echo "üîë –î–æ—Å—Ç—É–ø–Ω—ã–µ —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç—ã –ø–æ–¥–ø–∏—Å–∏:"
	security find-identity -p codesigning -v | cat

# –ë—ã—Å—Ç—Ä–∞—è —Å–±–æ—Ä–∫–∞ –¥–ª—è —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏ (–±–µ–∑ –ø–æ–¥–ø–∏—Å–∏)
dev-app: clean
	@echo "üöÄ –ë—ã—Å—Ç—Ä–∞—è —Å–±–æ—Ä–∫–∞ –¥–ª—è —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏..."
	cd $(CLIENT_DIR) && python3 -m PyInstaller --clean -y $(PACKAGING_DIR)/Nexy.spec
	@echo "‚úÖ –ì–æ—Ç–æ–≤–æ: $(APP_PATH)"
	@echo "üí° –î–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è: make test-app"

# –ù–∞—Å—Ç—Ä–æ–π–∫–∞ notarytool (—É–∂–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–æ)
setup-notary:
	@echo "‚úÖ –ü—Ä–æ—Ñ–∏–ª—å $(APPLE_NOTARY_PROFILE) —É–∂–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω"
	@echo "üìã –ò—Å—Ç–æ—Ä–∏—è –Ω–æ—Ç–∞—Ä–∏–∑–∞—Ü–∏–∏:"
	xcrun notarytool history --keychain-profile $(APPLE_NOTARY_PROFILE) | head -5
