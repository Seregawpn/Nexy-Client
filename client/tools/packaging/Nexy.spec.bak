# -*- mode: python ; coding: utf-8 -*-
"""
Nexy.spec - PyInstaller specification для сборки macOS .app
Простая версия без Sparkle для тестирования
"""

import os

# Определяем пути
CURRENT_DIR = "/Users/sergiyzasorin/Desktop/Development/Nexy/client/tools/packaging"
CLIENT_DIR = "/Users/sergiyzasorin/Desktop/Development/Nexy/client"

# Основные параметры
APP_NAME = "Nexy"
BUNDLE_ID = "com.nexy.assistant"
VERSION = "2.5.0"
BUILD = "20500"
CODESIGN_ID = "Developer ID Application: Sergiy Zasorin (5NKLL2CLB9)"
ENTITLEMENTS_FILE = os.path.join(CURRENT_DIR, 'entitlements.plist')

block_cipher = None

a = Analysis(
    [os.path.join(CLIENT_DIR, 'main.py')],
    pathex=[CLIENT_DIR],
    binaries=[],
    datas=[
        # Конфигурационные файлы
        (os.path.join(CLIENT_DIR, 'config'), 'config'),
        # Иконки и ресурсы
        (os.path.join(CLIENT_DIR, 'assets'), 'assets'),
    ],
    hiddenimports=[
        # Основные зависимости
        'rumps', 'asyncio', 'grpc', 'pyaudio', 'PIL', 'speech_recognition', 'pynput', 'psutil', 'keyring', 'cryptography',
        # Аудио модули
        'sounddevice', 'numpy', 'PyObjC', 'CoreAudio', 'Foundation', 'AppKit',
        # gRPC и сеть
        'grpc_tools', 'google.protobuf', 'google.api_core', 'grpc_status',
        # Системные модули macOS
        'Quartz', 'CoreGraphics', 'CoreVideo', 'HIServices',
        # Модули проекта
        'integration', 'integration.core', 'integration.integrations', 'integration.workflows', 'modules', 'modules.audio_device_manager', 'modules.grpc_client', 'modules.hardware_id', 'modules.input_processing', 'modules.interrupt_management', 'modules.mode_management', 'modules.network_manager', 'modules.permissions', 'modules.screenshot_capture', 'modules.signals', 'modules.speech_playback', 'modules.tray_controller', 'modules.update_manager', 'modules.voice_recognition',
    ],
    hookspath=[],
    runtime_hooks=[],
    excludes=[
        'tkinter', 'PyQt5', 'PyQt6', 'PySide2', 'PySide6', 'wx',
        'matplotlib', 'scipy', 'pandas', 'jupyter', 'IPython', 'notebook',
        'flask', 'django', 'tornado', 'bottle',
        'unittest', 'pytest', 'nose', 'test', 'tests',
        'sphinx', 'docutils',
        'setuptools', 'pip', 'wheel', 'distutils',
    ],
    noarchive=False,
)

pyz = PYZ(a.pure, a.zipped_data, cipher=block_cipher)

exe = EXE(
    pyz,
    a.scripts,
    [],
    exclude_binaries=True,
    name=APP_NAME,
    debug=False,
    bootloader_ignore_signals=False,
    strip=False,
    upx=False,
    console=False,
    disable_windowed_traceback=False,
    argv_emulation=False,
    target_arch=None,
    codesign_identity=None,
    entitlements_file=ENTITLEMENTS_FILE,
)

coll = COLLECT(
    exe,
    a.binaries,
    a.zipfiles,
    a.datas,
    strip=False,
    upx=False,
    upx_exclude=[],
    name=APP_NAME,
)

app = BUNDLE(
    coll,
    name=f'{APP_NAME}.app',
    icon=os.path.join(CLIENT_DIR, 'assets', 'logo.icns'),
    bundle_identifier=BUNDLE_ID,
    info_plist={
        'CFBundleName': APP_NAME,
        'CFBundleDisplayName': 'Nexy AI Assistant',
        'CFBundleShortVersionString': VERSION,
        'CFBundleVersion': BUILD,
        'CFBundleIdentifier': BUNDLE_ID,
        'CFBundleExecutable': APP_NAME,
        'CFBundlePackageType': 'APPL',
        'CFBundleSignature': 'NEXY',
        'LSMinimumSystemVersion': '11.0',
        'LSBackgroundOnly': True,
        'LSUIElement': True,
        'NSMicrophoneUsageDescription': 'Nexy нужен доступ к микрофону для распознавания голосовых команд и записи речи',
        'NSCameraUsageDescription': 'Nexy может использовать камеру для расширенного анализа контекста',
        'NSScreenCaptureUsageDescription': 'Nexy делает скриншоты для понимания контекста вашего экрана',
        'NSUserNotificationUsageDescription': 'Nexy отправляет уведомления о статусе и результатах обработки',
        'NSAppleEventsUsageDescription': 'Nexy использует Apple Events для автоматизации задач и мониторинга клавиатуры',
        'NSDesktopFolderUsageDescription': 'Nexy сохраняет файлы на рабочий стол для обработки',
        'NSDocumentsFolderUsageDescription': 'Nexy сохраняет документы в папку Документы',
        'NSSpeechRecognitionUsageDescription': 'Nexy использует распознавание речи для преобразования голосовых команд в текст',
        'NSAudioUsageDescription': 'Nexy использует аудио для обработки голосовых команд и аудио обратной связи',
        'NSNetworkUsageDescription': 'Nexy использует сеть для отправки данных на серверы обработки',
        'LSApplicationCategoryType': 'public.app-category.productivity',
        'LSArchitecturePriority': ['arm64', 'x86_64'],
        'NSHighResolutionCapable': True,
        'CFBundleDocumentTypes': [],
        'CFBundleURLTypes': [],
    },
    argv_emulation=False,
    target_arch='universal2',
)
