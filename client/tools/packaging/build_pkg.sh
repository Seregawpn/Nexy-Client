#!/usr/bin/env bash
# –§–∏–Ω–∞–ª—å–Ω—ã–π —Å–∫—Ä–∏–ø—Ç —Å–±–æ—Ä–∫–∏ PKG —Å –Ω–æ—Ç–∞—Ä–∏—Ñ–∏–∫–∞—Ü–∏–µ–π
# –û—Å–Ω–æ–≤–∞–Ω –Ω–∞ –ø–æ–ª–Ω–æ–º —á–µ–∫-–ª–∏—Å—Ç–µ PyInstaller + Sparkle + PKG

set -euo pipefail

# ========================================
# –ö–û–ù–§–ò–ì–£–†–ê–¶–ò–Ø (–ó–ê–ú–ï–ù–ò–¢–ï –ù–ê –°–í–û–ò –ó–ù–ê–ß–ï–ù–ò–Ø)
# ========================================
APP_NAME="Nexy"
SPEC_FILE="Nexy.spec"
DIST_DIR="../dist"
PKG="${DIST_DIR}/${APP_NAME}.pkg"

# –°–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç—ã (—É–∂–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω—ã)
APP_ID="Developer ID Application: Sergiy Zasorin (5NKLL2CLB9)"
PKG_ID="Developer ID Installer: Sergiy Zasorin (5NKLL2CLB9)"

# Notarytool –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
APPLE_ID="sergiyzasorin@gmail.com"  # TODO: –∑–∞–º–µ–Ω–∏—Ç–µ –Ω–∞ –≤–∞—à email
TEAM_ID="5NKLL2CLB9"
PROFILE="nexy-notary"

echo "üîß –ù–∞—á–∏–Ω–∞–µ–º —Ñ–∏–Ω–∞–ª—å–Ω—É—é —Å–±–æ—Ä–∫—É PKG —Å –Ω–æ—Ç–∞—Ä–∏—Ñ–∏–∫–∞—Ü–∏–µ–π..."

# ========================================
# –®–ê–ì 1: –û—á–∏—Å—Ç–∫–∞ –ø—Ä–µ–¥—ã–¥—É—â–∏—Ö —Å–±–æ—Ä–æ–∫
# ========================================
echo "üßπ –û—á–∏—â–∞–µ–º –ø—Ä–µ–¥—ã–¥—É—â–∏–µ —Å–±–æ—Ä–∫–∏..."
rm -rf build "${DIST_DIR}" || true

# ========================================
# –®–ê–ì 2: –°–±–æ—Ä–∫–∞ .app —á–µ—Ä–µ–∑ PyInstaller
# ========================================
echo "üî® –°–æ–±–∏—Ä–∞–µ–º .app —á–µ—Ä–µ–∑ PyInstaller..."
cd ../..
python3 -m PyInstaller --clean -y client/tools/packaging/${SPEC_FILE}
cd ../..ols/packaging

# ========================================
# –®–ê–ì 3: –û—á–∏—Å—Ç–∫–∞ extended attributes (–ö–†–ò–¢–ò–ß–ù–û!)
# ========================================
echo "üßπ –û—á–∏—â–∞–µ–º extended attributes..."
xattr -rc "${DIST_DIR}/${APP_NAME}.app"

# ========================================
# –®–ê–ì 4: –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–¥–ø–∏—Å–∏ .app
# ========================================
echo "üîç –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–æ–¥–ø–∏—Å—å .app..."
if codesign --verify --deep --strict --verbose=2 "${DIST_DIR}/${APP_NAME}.app"; then
    echo "‚úÖ .app –ø–æ–¥–ø–∏—Å–∞–Ω –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ"
else
    echo "‚ùå .app –Ω–µ –ø–æ–¥–ø–∏—Å–∞–Ω –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ"
    exit 1
fi

# –ü—Ä–æ–≤–µ—Ä–∫–∞ Gatekeeper (–º–æ–∂–µ—Ç –Ω–µ –ø—Ä–æ–π—Ç–∏ –¥–ª—è –Ω–µ–ø–æ–¥–ø–∏—Å–∞–Ω–Ω—ã—Ö –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–π)
echo "üîç –ü—Ä–æ–≤–µ—Ä—è–µ–º Gatekeeper..."
if spctl -a -vv "${DIST_DIR}/${APP_NAME}.app" 2>/dev/null; then
    echo "‚úÖ .app –ø—Ä–æ—à–µ–ª –ø—Ä–æ–≤–µ—Ä–∫—É Gatekeeper"
else
    echo "‚ö†Ô∏è .app –Ω–µ –ø—Ä–æ—à–µ–ª –ø—Ä–æ–≤–µ—Ä–∫—É Gatekeeper (–Ω–æ—Ä–º–∞–ª—å–Ω–æ –¥–ª—è –Ω–µ–ø–æ–¥–ø–∏—Å–∞–Ω–Ω—ã—Ö –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–π)"
fi

# ========================================
# –®–ê–ì 5: –°–±–æ—Ä–∫–∞ –∏ –ø–æ–¥–ø–∏—Å—å PKG
# ========================================
echo "üì¶ –°–æ–∑–¥–∞–µ–º –∏ –ø–æ–¥–ø–∏—Å—ã–≤–∞–µ–º PKG..."
pkgbuild \
  --component "${DIST_DIR}/${APP_NAME}.app" \
  --install-location "/Applications" \
  --sign "${PKG_ID}" \
  "${PKG}"

# ========================================
# –®–ê–ì 6: –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–¥–ø–∏—Å–∏ PKG
# ========================================
echo "üîç –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–æ–¥–ø–∏—Å—å PKG..."
if pkgutil --check-signature "${PKG}"; then
    echo "‚úÖ PKG –ø–æ–¥–ø–∏—Å–∞–Ω –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ"
else
    echo "‚ùå PKG –Ω–µ –ø–æ–¥–ø–∏—Å–∞–Ω –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ"
    exit 1
fi

# ========================================
# –®–ê–ì 7: –ù–æ—Ç–∞—Ä–∏—Ñ–∏–∫–∞—Ü–∏—è PKG
# ========================================
echo "üìã –û—Ç–ø—Ä–∞–≤–ª—è–µ–º PKG –Ω–∞ –Ω–æ—Ç–∞—Ä–∏–∑–∞—Ü–∏—é..."
SUBMISSION_ID=$(xcrun notarytool submit "${PKG}" \
  --apple-id "${APPLE_ID}" \
  --team-id "${TEAM_ID}" \
  --keychain-profile "${PROFILE}" \
  --wait | grep "id:" | cut -d' ' -f2)

if [ -n "$SUBMISSION_ID" ]; then
    echo "‚úÖ PKG –Ω–æ—Ç–∞—Ä–∏–∑–∏—Ä–æ–≤–∞–Ω —É—Å–ø–µ—à–Ω–æ (ID: $SUBMISSION_ID)"
else
    echo "‚ùå –û—à–∏–±–∫–∞ –Ω–æ—Ç–∞—Ä–∏–∑–∞—Ü–∏–∏"
    exit 1
fi

# ========================================
# –®–ê–ì 8: –°–∫—Ä–µ–ø–ª–µ–Ω–∏–µ –Ω–æ—Ç–∞—Ä–∏–∑–∞—Ü–∏–∏
# ========================================
echo "üìå –°–∫—Ä–µ–ø–ª—è–µ–º –Ω–æ—Ç–∞—Ä–∏–∑–∞—Ü–∏—é..."
if xcrun stapler staple "${PKG}"; then
    echo "‚úÖ –ù–æ—Ç–∞—Ä–∏–∑–∞—Ü–∏—è —Å–∫—Ä–µ–ø–ª–µ–Ω–∞"
else
    echo "‚ùå –û—à–∏–±–∫–∞ —Å–∫—Ä–µ–ø–ª–µ–Ω–∏—è –Ω–æ—Ç–∞—Ä–∏–∑–∞—Ü–∏–∏"
    exit 1
fi

# ========================================
# –®–ê–ì 9: –§–∏–Ω–∞–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞
# ========================================
echo "üîç –§–∏–Ω–∞–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ PKG..."
if xcrun stapler validate "${PKG}"; then
    echo "‚úÖ PKG –ø—Ä–æ—à–µ–ª —Ñ–∏–Ω–∞–ª—å–Ω—É—é –ø—Ä–æ–≤–µ—Ä–∫—É"
else
    echo "‚ö†Ô∏è PKG –Ω–µ –ø—Ä–æ—à–µ–ª —Ñ–∏–Ω–∞–ª—å–Ω—É—é –ø—Ä–æ–≤–µ—Ä–∫—É"
fi

# ========================================
# –†–ï–ó–£–õ–¨–¢–ê–¢
# ========================================
echo ""
echo "üéâ –°–±–æ—Ä–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞ —É—Å–ø–µ—à–Ω–æ!"
echo "üìç –ì–æ—Ç–æ–≤—ã–π .app: ${DIST_DIR}/${APP_NAME}.app"
echo "üìç –ì–æ—Ç–æ–≤—ã–π PKG: ${PKG}"
echo ""
echo "üí° –î–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è —É—Å—Ç–∞–Ω–æ–≤–∫–∏:"
echo "   sudo installer -pkg \"${PKG}\" -target /"
echo ""
echo "üí° –î–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è appcast.xml:"
echo "   ./sign_appcast.sh local_server/updates/appcast.xml"
