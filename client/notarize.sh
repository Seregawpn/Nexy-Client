#!/bin/bash
set -e

# –ó–∞–≥—Ä—É–∂–∞–µ–º –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é
source "$(dirname "$0")/notarize_config.sh"

PKG_NAME="$1"

if [ -z "$PKG_NAME" ]; then
    echo "‚ùå –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ: ./notarize.sh <PKG_NAME>"
    exit 1
fi

echo "üîê –ù–æ—Ç–∞—Ä–∏–∑–∞—Ü–∏—è PKG: $PKG_NAME"

# –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏—è —Ñ–∞–π–ª–∞
if [ ! -f "$PKG_NAME" ]; then
    echo "‚ùå PKG —Ñ–∞–π–ª –Ω–µ –Ω–∞–π–¥–µ–Ω: $PKG_NAME"
    exit 1
fi

# –û—Ç–ø—Ä–∞–≤–∫–∞ –Ω–∞ –Ω–æ—Ç–∞—Ä–∏–∑–∞—Ü–∏—é
echo "üì§ –û—Ç–ø—Ä–∞–≤–∫–∞ –Ω–∞ –Ω–æ—Ç–∞—Ä–∏–∑–∞—Ü–∏—é Apple..."
if xcrun notarytool submit "$PKG_NAME" \
    --apple-id "$APPLE_ID" \
    --password "$APP_PASSWORD" \
    --team-id "$TEAM_ID" \
    --wait; then
    echo "‚úÖ –ù–æ—Ç–∞—Ä–∏–∑–∞—Ü–∏—è –ø—Ä–æ—à–ª–∞ —É—Å–ø–µ—à–Ω–æ"
else
    echo "‚ùå –û—à–∏–±–∫–∞ –Ω–æ—Ç–∞—Ä–∏–∑–∞—Ü–∏–∏"
    exit 1
fi

# –ü—Ä–∏–∫—Ä–µ–ø–ª–µ–Ω–∏–µ —Ç–∏–∫–µ—Ç–∞
echo "üìé –ü—Ä–∏–∫—Ä–µ–ø–ª–µ–Ω–∏–µ –Ω–æ—Ç–∞—Ä–∏–∑–∞—Ü–∏–æ–Ω–Ω–æ–≥–æ —Ç–∏–∫–µ—Ç–∞..."
if xcrun stapler staple "$PKG_NAME"; then
    echo "‚úÖ –¢–∏–∫–µ—Ç –ø—Ä–∏–∫—Ä–µ–ø–ª–µ–Ω —É—Å–ø–µ—à–Ω–æ"
else
    echo "‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏–∫—Ä–µ–ø–ª–µ–Ω–∏—è —Ç–∏–∫–µ—Ç–∞"
    exit 1
fi

echo "‚úÖ PKG –Ω–æ—Ç–∞—Ä–∏–∑–æ–≤–∞–Ω –∏ –≥–æ—Ç–æ–≤ –∫ —Ä–∞—Å–ø—Ä–æ—Å—Ç—Ä–∞–Ω–µ–Ω–∏—é!"
